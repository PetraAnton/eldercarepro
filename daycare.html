<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Daycare - Bản Mockup</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .active-module {
            border-color: #2563eb;
            background-color: #f8fafc;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .sidebar-item-active {
            background-color: #2563eb;
            color: white;
        }

        .hidden-section {
            display: none;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        /* Animation cho mượt */
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <link rel="stylesheet" href="print.css">
</head>

<body class="bg-[#f8fafc] text-slate-900 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-72 bg-slate-900 flex-col text-white hidden lg:flex shadow-2xl z-20">
        <div class="p-8 border-b border-slate-800 flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-500/20"><i data-lucide="activity"
                    class="text-white"></i></div>
            <span class="font-extrabold text-xl tracking-tight">ELDERCARE <span class="text-blue-500">PRO</span></span>
        </div>

        <nav class="flex-1 p-6 space-y-3 overflow-y-auto">
            <p class="text-[10px] font-black text-slate-500 uppercase tracking-[2px] mb-2 px-4">Quản lý</p>
            <button onclick="switchTab('patients')" id="btn-patients"
                class="sidebar-item-active w-full flex items-center gap-3 px-5 py-4 rounded-2xl transition-all font-bold text-sm">
                <i data-lucide="users" class="w-5 h-5"></i> Danh sách bệnh nhân
            </button>
            <button onclick="switchTab('business')" id="btn-business"
                class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl transition-all text-slate-400 hover:bg-slate-800 hover:text-white font-bold text-sm">
                <i data-lucide="clipboard-list" class="w-5 h-5"></i> Nghiệp vụ
            </button>

            <p class="text-[10px] font-black text-slate-500 uppercase tracking-[2px] mt-8 mb-2 px-4">Hệ thống</p>
            <button onclick="openSettingsModal()"
                class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl text-slate-400 hover:bg-slate-800 font-bold text-sm">
                <i data-lucide="settings" class="w-5 h-5"></i> Cài đặt
            </button>
        </nav>

        <div class="p-6 border-t border-slate-800">
            <button onclick="logout()"
                class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl text-rose-400 hover:bg-rose-900/20 font-bold text-sm transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i> Đăng xuất
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        <!-- Header -->
        <header class="h-20 bg-white border-b flex items-center justify-between px-10 z-10 shadow-sm">
            <div>
                <h2 id="header-title" class="text-xl font-black text-slate-800 tracking-tight">Danh sách bệnh nhân</h2>
                <p id="header-subtitle" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Trung tâm
                    Daycare Phục hồi chức năng</p>
            </div>

            <div class="flex items-center gap-4">
                <!-- User Profile -->
                <div class="relative">
                    <button id="user-profile-btn" onclick="toggleUserProfile()"
                        class="flex items-center gap-3 px-4 py-2 bg-slate-50 hover:bg-slate-100 rounded-2xl border border-slate-200 transition-all">
                        <div id="header-user-avatar"
                            class="w-8 h-8 rounded-xl bg-indigo-600 flex items-center justify-center text-white text-sm font-black shadow-lg shadow-indigo-500/20">
                            A
                        </div>
                        <div class="text-left hidden md:block">
                            <p id="header-user-name" class="text-xs font-bold text-slate-800">Administrator</p>
                            <p id="header-user-role" class="text-[9px] text-slate-400 font-semibold">Quản trị viên</p>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 transition-colors"></i>
                    </button>

                    <!-- User Dropdown -->
                    <div id="user-profile-dropdown"
                        class="hidden absolute right-0 mt-2 w-56 bg-white rounded-2xl shadow-2xl border border-slate-200 z-50 p-2 animate-fade-in">
                        <div class="p-3 border-b border-slate-100 mb-2">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Tài khoản</p>
                        </div>
                        <button onclick="openUserProfileModal()"
                            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 font-bold text-xs transition-all">
                            <i data-lucide="user" class="w-4 h-4"></i> Hồ sơ cá nhân
                        </button>
                        <button onclick="openSettingsModal()"
                            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 font-bold text-xs transition-all">
                            <i data-lucide="settings" class="w-4 h-4"></i> Cài đặt
                        </button>
                        <div class="h-px bg-slate-100 my-2"></div>
                        <button onclick="logout()"
                            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-rose-500 hover:bg-rose-50 font-bold text-xs transition-all">
                            <i data-lucide="log-out" class="w-4 h-4"></i> Đăng xuất
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-10">

            <!-- Patient List Section -->
            <section id="section-patients" class="max-w-7xl mx-auto space-y-10 animate-fade-in">

                <div class="bg-white rounded-[40px] border border-slate-100 shadow-sm overflow-hidden">
                    <div class="p-8 border-b flex justify-between items-center bg-slate-50/30">
                        <div>
                            <h3 class="font-black text-slate-800 text-lg tracking-tight">Danh sách bệnh nhân</h3>
                            <!-- Status Filter Buttons -->
                            <div class="flex gap-2 mt-3">
                                <button onclick="filterPatients('all')" id="filter-all"
                                    class="px-4 py-2 rounded-xl text-xs font-bold bg-blue-600 text-white">
                                    Tất cả
                                </button>
                                <button onclick="filterPatients('active')" id="filter-active"
                                    class="px-4 py-2 rounded-xl text-xs font-bold bg-slate-100 text-slate-600 hover:bg-slate-200">
                                    Đang hoạt động
                                </button>
                                <button onclick="filterPatients('inactive')" id="filter-inactive"
                                    class="px-4 py-2 rounded-xl text-xs font-bold bg-slate-100 text-slate-600 hover:bg-slate-200">
                                    Đã vô hiệu
                                </button>
                            </div>
                        </div>
                        <button onclick="openCreatePatientModal()"
                            class="px-6 py-3 bg-blue-600 text-white rounded-2xl font-black text-sm hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Tạo bệnh nhân mới
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-white text-slate-400 text-[10px] uppercase font-black tracking-widest">
                                <tr>
                                    <th class="px-10 py-6">Tên Bệnh nhân</th>
                                    <th class="px-10 py-6">Mức độ</th>
                                    <th class="px-10 py-6">Trạng thái</th>
                                    <th class="px-10 py-6 text-right">Hành động</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50 text-sm font-medium">
                                <tr class="hover:bg-slate-50/50 transition-all">
                                    <td class="px-10 py-6 text-slate-800 flex items-center gap-4">
                                        <div
                                            class="w-10 h-10 rounded-2xl bg-blue-100 flex items-center justify-center text-blue-600 font-black">
                                            A</div>
                                        Nguyễn Văn A
                                    </td>
                                    <td class="px-10 py-6 text-slate-600">Chăm sóc 2</td>
                                    <td class="px-10 py-6"><span
                                            class="px-4 py-1.5 bg-emerald-100 text-emerald-700 rounded-full text-[10px] font-black uppercase tracking-wider">Đang
                                            hoạt động</span></td>
                                    <td class="px-10 py-6 text-right">
                                        <button onclick="openPatient(1)"
                                            class="bg-slate-900 text-white px-6 py-2 rounded-2xl text-xs font-black hover:bg-blue-600 transition-all shadow-lg shadow-slate-200">Chi
                                            tiết hồ sơ</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Business Processes Section -->
            <section id="section-business" class="hidden-section max-w-7xl mx-auto space-y-8 animate-fade-in">
                <!-- Profile Card -->
                <div
                    class="bg-white p-8 rounded-[40px] border shadow-sm flex flex-col md:flex-row gap-8 items-center border-slate-100 relative">
                    <div id="patient-avatar"
                        class="w-24 h-24 rounded-[32px] bg-gradient-to-br from-blue-600 to-indigo-700 flex items-center justify-center text-white text-4xl font-black shadow-2xl shadow-blue-500/20">
                        ?
                    </div>
                    <div class="flex-1 text-center md:text-left">
                        <div class="flex items-center justify-center md:justify-start gap-4 mb-2">
                            <h1 id="patient-detail-name" class="text-3xl font-black text-slate-800 tracking-tight">Chưa
                                chọn bệnh nhân</h1>
                            <!-- Patient Switcher Dropdown (Hidden trigger, styled as button) -->
                            <div class="relative group">
                                <button
                                    onclick="document.getElementById('patient-switcher-dropdown').classList.toggle('hidden')"
                                    class="p-2 bg-slate-50 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all"
                                    title="Chuyển bệnh nhân">
                                    <i data-lucide="arrow-left-right" class="w-5 h-5"></i>
                                </button>
                                <div id="patient-switcher-dropdown"
                                    class="hidden absolute top-full left-0 mt-2 w-64 bg-white rounded-2xl shadow-xl border border-slate-100 z-50 overflow-hidden max-h-60 overflow-y-auto animate-fade-in">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>

                        <div
                            class="flex flex-wrap gap-4 text-[11px] font-bold text-slate-400 justify-center md:justify-start">
                            <span id="patient-detail-care-level"
                                class="bg-slate-100 px-3 py-1 rounded-lg text-slate-600 uppercase">---</span>
                            <span id="patient-detail-id">ID: ---</span>
                            <span id="patient-detail-age-gender">--- • ---</span>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="switchTab('patients')"
                            class="px-6 py-4 bg-slate-100 text-slate-600 rounded-3xl font-black text-sm hover:bg-slate-200 transition-all">
                            Quay lại danh sách</button>
                    </div>
                </div>

                <!-- 9 Modules Workspace -->
                <div class="flex flex-col lg:flex-row gap-10 pb-16">
                    <!-- Nav Tabs -->
                    <div id="module-tabs" class="w-full lg:w-80 space-y-3">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[3px] mb-6 pl-4">9 Nghiệp vụ
                            quản lý</p>
                        <!-- Module items via JS -->
                    </div>

                    <!-- Work Area -->
                    <div
                        class="flex-1 bg-white rounded-[40px] border border-slate-100 shadow-sm overflow-hidden min-h-[600px] flex flex-col">
                        <div class="p-10 border-b bg-slate-50/40 flex justify-between items-center">
                            <div>
                                <h2 id="module-title" class="text-3xl font-black text-slate-800 tracking-tight italic">
                                    Face Sheet</h2>
                                <p class="text-[10px] text-blue-500 font-extrabold uppercase mt-2 tracking-[2px]">Tiêu
                                    chuẩn phục hồi chức năng Nhật Bản</p>
                            </div>
                        </div>
                        <div id="module-content" class="p-10 flex-1 overflow-y-auto min-h-[400px]">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Patient Creation Modal -->
    <div id="create-patient-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[40px] shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-8 border-b border-slate-100">
                <h2 class="text-2xl font-black text-slate-800">Tạo bệnh nhân mới</h2>
                <p class="text-sm text-slate-500 mt-1">Nhập thông tin cơ bản của bệnh nhân</p>
            </div>

            <form id="create-patient-form" class="p-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Họ và tên <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="new-patient-name" required
                            class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium"
                            placeholder="Nguyễn Văn A">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ngày sinh <span
                                class="text-red-500">*</span></label>
                        <input type="date" id="new-patient-dob" required
                            class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Giới tính <span
                                class="text-red-500">*</span></label>
                        <select id="new-patient-gender" required
                            class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium">
                            <option value="">Chọn giới tính</option>
                            <option value="male">Nam</option>
                            <option value="female">Nữ</option>
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Mức chăm sóc</label>
                        <select id="new-patient-care-level"
                            class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium">
                            <option value="Chăm sóc 1">Chăm sóc 1</option>
                            <option value="Chăm sóc 2">Chăm sóc 2</option>
                            <option value="Chăm sóc 3">Chăm sóc 3</option>
                            <option value="Chăm sóc 4">Chăm sóc 4</option>
                            <option value="Chăm sóc 5">Chăm sóc 5</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeCreatePatientModal()"
                        class="flex-1 px-6 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all">
                        Hủy
                    </button>
                    <button type="submit"
                        class="flex-1 px-6 py-4 bg-blue-600 text-white rounded-2xl font-black text-sm hover:bg-blue-700 shadow-xl shadow-blue-500/20 transition-all">
                        Tạo bệnh nhân
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Patient Deactivation Modal -->
    <div id="deactivate-patient-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <!-- ... existing modal content ... -->
        <div class="bg-white rounded-[40px] shadow-2xl max-w-lg w-full">
            <div class="p-8 border-b border-slate-100">
                <h2 class="text-2xl font-black text-slate-800">Vô hiệu hóa bệnh nhân</h2>
                <p class="text-sm text-slate-500 mt-1">Bệnh nhân sẽ được đánh dấu là không hoạt động</p>
            </div>

            <form id="deactivate-patient-form" class="p-8 space-y-6">
                <input type="hidden" id="deactivate-patient-id">

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Lý do vô hiệu hóa <span
                            class="text-red-500">*</span></label>
                    <select id="deactivation-reason" required
                        class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium">
                        <option value="">Chọn lý do</option>
                        <option value="discharged">Đã xuất viện</option>
                        <option value="transferred">Chuyển viện</option>
                        <option value="deceased">Đã mất</option>
                        <option value="other">Lý do khác</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Ghi chú</label>
                    <textarea id="deactivation-notes" rows="3"
                        class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium resize-none"
                        placeholder="Thông tin bổ sung (không bắt buộc)"></textarea>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeDeactivateModal()"
                        class="flex-1 px-6 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all">
                        Hủy
                    </button>
                    <button type="submit"
                        class="flex-1 px-6 py-4 bg-red-600 text-white rounded-2xl font-black text-sm hover:bg-red-700 shadow-xl shadow-red-500/20 transition-all">
                        Vô hiệu hóa
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Login/Register Overlay -->
    <div id="login-overlay"
        class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center transition-all duration-500">
        <!-- Background Decor -->
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-blue-900 to-slate-900 opacity-90">
            </div>
            <div
                class="absolute -top-1/2 -left-1/2 w-[100rem] h-[100rem] bg-blue-600/20 rounded-full blur-3xl animate-pulse">
            </div>
            <div
                class="absolute -bottom-1/2 -right-1/2 w-[100rem] h-[100rem] bg-indigo-600/20 rounded-full blur-3xl animate-pulse delay-1000">
            </div>
        </div>

        <!-- Login Card -->
        <div
            class="relative bg-white/95 backdrop-blur-xl p-10 rounded-[40px] shadow-2xl w-full max-w-md mx-4 border border-white/20">

            <!-- Login Form -->
            <div id="login-form-container" class="space-y-8">
                <div class="text-center space-y-3">
                    <div
                        class="bg-blue-600 w-16 h-16 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-blue-500/30 mb-6">
                        <i data-lucide="activity" class="text-white w-8 h-8"></i>
                    </div>
                    <h1 class="text-3xl font-black text-slate-900 tracking-tight">Chào mừng trở lại</h1>
                    <p class="text-slate-500 font-medium">Đăng nhập vào hệ thống ElderCare Pro</p>
                </div>

                <form id="login-form" class="space-y-5">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">Tên đăng
                            nhập</label>
                        <div class="relative">
                            <i data-lucide="user"
                                class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="text" id="login-username" required placeholder="admin"
                                class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-bold text-slate-700 placeholder:font-normal">
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">Mật khẩu</label>
                        <div class="relative">
                            <i data-lucide="lock"
                                class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="password" id="login-password" required placeholder="••••••"
                                class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-bold text-slate-700 placeholder:font-normal">
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="login-remember"
                                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-xs font-bold text-slate-500">Ghi nhớ đăng nhập</span>
                        </label>
                    </div>

                    <button type="submit"
                        class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black text-sm shadow-xl shadow-blue-500/20 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                        Đăng nhập
                    </button>
                </form>

                <div class="text-center pt-2">
                    <p class="text-sm text-slate-500 font-bold">
                        Chưa có tài khoản?
                        <button onclick="toggleAuthMode('register')"
                            class="text-blue-600 hover:text-blue-700 hover:underline">Tạo tài khoản mới</button>
                    </p>
                </div>
            </div>

            <!-- Register Form (Hidden by default) -->
            <div id="register-form-container" class="hidden space-y-8">
                <div class="text-center space-y-3">
                    <div
                        class="bg-emerald-500 w-16 h-16 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-emerald-500/30 mb-6">
                        <i data-lucide="user-plus" class="text-white w-8 h-8"></i>
                    </div>
                    <h1 class="text-3xl font-black text-slate-900 tracking-tight">Tạo tài khoản</h1>
                    <p class="text-slate-500 font-medium">Đăng ký tài khoản nhân viên mới</p>
                </div>

                <form id="register-form" class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider pl-1">Họ và
                            tên</label>
                        <input type="text" id="reg-fullname" required placeholder="Nguyễn Văn A"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 outline-none transition-all font-bold text-slate-700 placeholder:font-normal">
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider pl-1">Tên đăng
                            nhập</label>
                        <input type="text" id="reg-username" required placeholder="user123"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 outline-none transition-all font-bold text-slate-700 placeholder:font-normal">
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider pl-1">Mật
                            khẩu</label>
                        <input type="password" id="reg-password" required placeholder="••••••"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 outline-none transition-all font-bold text-slate-700 placeholder:font-normal">
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider pl-1">Nhập lại mật
                            khẩu</label>
                        <input type="password" id="reg-confirm-password" required placeholder="••••••"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 outline-none transition-all font-bold text-slate-700 placeholder:font-normal">
                    </div>

                    <button type="submit"
                        class="w-full py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-black text-sm shadow-xl shadow-emerald-500/20 transition-all transform hover:scale-[1.02] active:scale-[0.98] mt-2">
                        Đăng ký
                    </button>
                </form>

                <div class="text-center pt-2">
                    <p class="text-sm text-slate-500 font-bold">
                        Đã có tài khoản?
                        <button onclick="toggleAuthMode('login')"
                            class="text-blue-600 hover:text-blue-700 hover:underline">Đăng nhập</button>
                    </p>
                </div>
            </div>

        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
        <div class="bg-white rounded-[40px] shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-black text-slate-800">Cài đặt</h2>
                    <p class="text-sm text-slate-500 mt-1">Tùy chỉnh hệ thống</p>
                </div>
                <button onclick="closeSettingsModal()"
                    class="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-all">
                    <i data-lucide="x" class="w-5 h-5 text-slate-600"></i>
                </button>
            </div>

            <div class="p-8 space-y-8">
                <!-- Theme & Language (Mockup) -->
                <section class="space-y-4">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Giao diện</h3>
                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <div class="flex items-center gap-3">
                            <i data-lucide="moon" class="w-5 h-5 text-slate-600"></i>
                            <span class="font-bold text-slate-700 text-sm">Chế độ tối (Dark Mode)</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" disabled class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                            </div>
                        </label>
                    </div>
                    <p class="text-[10px] text-slate-400 italic text-center">* Tính năng đang phát triển</p>
                </section>

                <!-- Change Password -->
                <section class="space-y-4">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Bảo mật</h3>
                    <form id="change-password-form" class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Mật khẩu hiện tại</label>
                            <input type="password" id="set-old-pass" required
                                class="w-full px-4 py-2 rounded-xl border border-slate-200 text-sm font-bold shadow-sm focus:ring-2 focus:ring-blue-100 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Mật khẩu mới</label>
                            <input type="password" id="set-new-pass" required
                                class="w-full px-4 py-2 rounded-xl border border-slate-200 text-sm font-bold shadow-sm focus:ring-2 focus:ring-blue-100 outline-none">
                        </div>
                        <button type="submit"
                            class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold text-xs hover:bg-slate-900 transition-all">
                            Đổi mật khẩu
                        </button>
                    </form>
                </section>

                <!-- Data Management -->
                <section class="space-y-4">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Dữ liệu</h3>
                    <div class="p-4 bg-red-50 rounded-2xl border border-red-100 space-y-3">
                        <div class="flex items-center gap-3 text-red-700">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            <span class="font-bold text-sm">Reset dữ liệu Demo</span>
                        </div>
                        <p class="text-xs text-red-600/80">Xóa toàn bộ bệnh nhân và dữ liệu đã nhập. Tài khoản sẽ đăng
                            xuất.</p>
                        <button onclick="confirmResetData()"
                            class="w-full py-3 bg-white border border-red-200 text-red-600 rounded-xl font-bold text-xs hover:bg-red-600 hover:text-white transition-all">
                            Xóa dữ liệu & Reset
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="user-profile-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
        <div class="bg-white rounded-[40px] shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center bg-indigo-50/50">
                <div>
                    <h2 class="text-2xl font-black text-indigo-900">Hồ sơ nhân viên</h2>
                    <p class="text-sm text-indigo-500 mt-1 font-bold">Thông tin cá nhân & chuyên môn</p>
                </div>
                <button onclick="closeUserProfileModal()"
                    class="p-2 bg-white rounded-full hover:bg-slate-100 transition-all border border-slate-100 shadow-sm">
                    <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                </button>
            </div>

            <form id="user-profile-form" class="p-8 space-y-8">
                <!-- Identity Section -->
                <section>
                    <h3
                        class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i data-lucide="badge-check" class="w-4 h-4"></i> Định danh
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Mã nhân viên (Identifier)</label>
                            <input type="text" id="up-identifier"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Họ và tên</label>
                            <input type="text" id="up-fullname" required
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                    </div>
                </section>

                <!-- Demographics -->
                <section>
                    <h3
                        class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i data-lucide="user" class="w-4 h-4"></i> Thông tin cá nhân
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Ngày sinh</label>
                            <input type="date" id="up-dob"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Giới tính</label>
                            <select id="up-gender"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                                <option value="">-- Chọn --</option>
                                <option value="male">Nam</option>
                                <option value="female">Nữ</option>
                                <option value="other">Khác</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Contact -->
                <section>
                    <h3
                        class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i data-lucide="phone" class="w-4 h-4"></i> Liên hệ
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Số điện thoại</label>
                            <input type="tel" id="up-phone"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Email</label>
                            <input type="email" id="up-email"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-600 mb-1">Địa chỉ</label>
                            <input type="text" id="up-address"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                    </div>
                </section>

                <!-- Qualification -->
                <section>
                    <h3
                        class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i data-lucide="award" class="w-4 h-4"></i> Chuyên môn
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Vai trò / Chức danh</label>
                            <input type="text" id="up-role" placeholder="VD: Điều dưỡng trưởng"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Chứng chỉ hành nghề</label>
                            <input type="text" id="up-qualification" placeholder="VD: CCHN-123456"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                    </div>
                </section>

                <div class="pt-4 border-t border-slate-100 flex justify-end gap-3">
                    <button type="button" onclick="closeUserProfileModal()"
                        class="px-6 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-xs hover:bg-slate-200 transition-all">
                        Hủy bỏ
                    </button>
                    <button type="submit"
                        class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold text-xs hover:bg-indigo-700 shadow-xl shadow-indigo-500/20 transition-all">
                        Lưu hồ sơ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="common.js"></script>
    <script src="module1.js"></script>
    <script src="module2.js"></script>
    <script src="module3.js"></script>
    <script src="module4.js"></script>
    <script src="module6.js"></script>
    <script src="module7.js"></script>

    <script>
        // --- State ---
        let currentModuleId = 1;
        let radarChartInstance = null;
        let trendChartInstance = null;
        let timelineChartInstance = null;

        const modules = [
            { id: 1, title: 'Face Sheet (Cơ bản)', icon: 'user' },
            { id: 2, title: 'Họp Phụ Trách', icon: 'message-square' },
            { id: 3, title: 'Đánh giá ADL/IADL', icon: 'clipboard-list' },
            { id: 4, title: 'Sở thích & Quan tâm', icon: 'heart' },
            { id: 5, title: 'Phân tích Tư thế', icon: 'activity' },
            { id: 6, title: 'Thành phần Cơ (SMI)', icon: 'bar-chart-3' },
            { id: 7, title: 'Chức năng vận động', icon: 'zap' },
            { id: 8, title: 'Bảo mật & Đồng ý', icon: 'shield-check' },
            { id: 9, title: 'Khảo sát Nhà ở', icon: 'home' }
        ];

        // --- Patient Management Functions ---

        function updateActivePatientDisplay() {
            // Also update patient detail profile
            updatePatientDetailProfile();
            renderPatientSwitcher();
        }

        function renderPatientSwitcher(filterText = '') {
            const patients = getAllPatients();
            const activeId = getCurrentPatientId();
            const container = document.getElementById('patient-switcher-dropdown');
            if (!container) return;

            // Filter patients if search text exists
            const filteredPatients = filterText
                ? patients.filter(p => p.fullName.toLowerCase().includes(filterText.toLowerCase()) || p.id.toLowerCase().includes(filterText.toLowerCase()))
                : patients;

            const listHtml = filteredPatients.map(p => `
                <button onclick="switchToPatient('${p.id}'); document.getElementById('patient-switcher-dropdown').classList.add('hidden');" 
                    class="w-full text-left px-4 py-3 hover:bg-slate-50 flex items-center gap-3 transition-colors border-b last:border-0 border-slate-50 ${p.id === activeId ? 'bg-blue-50/50' : ''}">
                    <div class="w-8 h-8 rounded-lg ${p.id === activeId ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-500'} flex items-center justify-center font-bold text-xs">
                        ${p.fullName.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1">
                        <p class="text-xs font-bold text-slate-700">${p.fullName}</p>
                        <p class="text-[9px] text-slate-400 uppercase">ID: ${p.id}</p>
                    </div>
                    ${p.id === activeId ? '<i data-lucide="check" class="w-4 h-4 text-blue-600"></i>' : ''}
                </button>
            `).join('');

            container.innerHTML = `
                <div class="p-3 border-b border-slate-100 sticky top-0 bg-white z-10">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                         <input type="text" placeholder="Tìm bệnh nhân..." 
                            oninput="renderPatientSwitcher(this.value)"
                            class="w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-blue-100"
                            value="${filterText}" autofocus>
                    </div>
                </div>
                <div class="max-h-60 overflow-y-auto">
                    ${listHtml.length > 0 ? listHtml : '<p class="text-xs text-slate-400 text-center py-4">Không tìm thấy</p>'}
                </div>
                <div class="p-2 border-t border-slate-100 sticky bottom-0 bg-white z-10">
                    <button onclick="document.getElementById('patient-switcher-dropdown').classList.add('hidden'); openCreatePatientModal();" 
                        class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-xl text-xs font-bold hover:bg-blue-700 transition-all">
                        <i data-lucide="plus" class="w-4 h-4"></i> Thêm bệnh nhân
                    </button>
                </div>
            `;

            // Focus input if filterText is present (to keep focus during re-render)
            if (filterText) {
                const input = container.querySelector('input');
                if (input) {
                    input.selectionStart = input.selectionEnd = input.value.length;
                    setTimeout(() => input.focus(), 0);
                }
            }

            lucide.createIcons();
        }

        function updatePatientDetailProfile() {
            const patientId = getCurrentPatientId();
            const patient = getPatientById(patientId);

            if (patient) {
                // Update avatar
                document.getElementById('patient-avatar').textContent = patient.fullName.charAt(0).toUpperCase();

                // Update name
                document.getElementById('patient-detail-name').textContent = patient.fullName;

                // Update care level
                document.getElementById('patient-detail-care-level').textContent = patient.careLevel || '---';

                // Update ID
                document.getElementById('patient-detail-id').textContent = 'ID: ' + patient.id;

                // Calculate age and format gender
                let ageGenderText = '--- • ---';
                if (patient.dateOfBirth) {
                    const birthDate = new Date(patient.dateOfBirth);
                    const age = new Date().getFullYear() - birthDate.getFullYear();
                    const genderText = patient.gender === 'male' ? 'Nam' : (patient.gender === 'female' ? 'Nữ' : '---');
                    ageGenderText = `${age} tuổi • ${genderText}`;
                }
                document.getElementById('patient-detail-age-gender').textContent = ageGenderText;
            } else {
                document.getElementById('patient-avatar').textContent = '?';
                document.getElementById('patient-detail-name').textContent = 'Chưa chọn bệnh nhân';
                document.getElementById('patient-detail-care-level').textContent = '---';
                document.getElementById('patient-detail-id').textContent = 'ID: ---';
                document.getElementById('patient-detail-age-gender').textContent = '--- • ---';
            }
        }

        function loadPatientList() {
            const patients = getAllPatients();
            const activePatientId = getCurrentPatientId();
            const listContainer = document.getElementById('patient-list');

            if (patients.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-4">Chưa có bệnh nhân nào</p>';
                return;
            }

            listContainer.innerHTML = patients.map(patient => {
                const isActive = patient.id === activePatientId;
                return `
                    <button onclick="switchToPatient('${patient.id}')" 
                        class="w-full p-3 rounded-xl hover:bg-slate-50 transition-all text-left ${isActive ? 'bg-blue-50 border-2 border-blue-200' : 'border-2 border-transparent'}">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center text-blue-600 font-black">
                                ${patient.fullName.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-slate-800">${patient.fullName}</p>
                                <p class="text-xs text-slate-400">${patient.id}</p>
                            </div>
                            ${isActive ? '<i data-lucide="check" class="w-4 h-4 text-blue-600"></i>' : ''}
                        </div>
                    </button>
                `;
            }).join('');

            lucide.createIcons();
        }

        // function togglePatientSwitcher() { ... } // Removed

        function switchToPatient(patientId) {
            setCurrentPatientId(patientId);

            // Update UI
            updateActivePatientDisplay();
            renderModuleTabs();

            // Reload current module to show data for new patient
            if (currentModuleId) {
                renderModuleView(currentModuleId);
            }

            // Show Toast removed to reduce noise or keep it
            // showToast('Đã chuyển sang bệnh nhân: ' + getPatientById(patientId).fullName, 'success');
        }

        function openCreatePatientModal() {
            document.getElementById('create-patient-modal').classList.remove('hidden');
        }

        function closeCreatePatientModal() {
            document.getElementById('create-patient-modal').classList.add('hidden');
            document.getElementById('create-patient-form').reset();
        }

        // --- User Profile Functions ---
        function toggleUserProfile() {
            const dropdown = document.getElementById('user-profile-dropdown');
            dropdown.classList.toggle('hidden');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (e) {
            // User Profile Dropdown
            const userBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-profile-dropdown');

            if (userBtn && userDropdown && !userBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                userDropdown.classList.add('hidden');
            }
        });



        // Handle patient creation form
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('create-patient-form').addEventListener('submit', function (e) {
                e.preventDefault();

                const patientData = {
                    fullName: document.getElementById('new-patient-name').value,
                    dateOfBirth: document.getElementById('new-patient-dob').value,
                    gender: document.getElementById('new-patient-gender').value,
                    careLevel: document.getElementById('new-patient-care-level').value
                };

                const newPatient = createPatient(patientData);

                closeCreatePatientModal();
                updateActivePatientDisplay();
                renderDashboard(); // Refresh dashboard table
                showToast('Đã tạo bệnh nhân: ' + newPatient.fullName, 'success');

                // Switch to patient detail view
                switchTab('patients');
                setActiveModule(1);
            });
        });

        // --- Scroll Helper Functions ---

        window.scrollToModule = (direction) => {
            // Target all potential scrollable containers
            const containers = [
                document.getElementById('module-content'),
                document.getElementById('content-area'),
                window
            ];

            containers.forEach(container => {
                if (!container) return;

                try {
                    if (direction === 'top') {
                        container.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        // For window/document, scrollHeight is on body/documentElement
                        let scrollHeight;
                        if (container === window) {
                            scrollHeight = Math.max(
                                document.body.scrollHeight,
                                document.documentElement.scrollHeight,
                                document.body.offsetHeight,
                                document.documentElement.offsetHeight,
                                document.body.clientHeight,
                                document.documentElement.clientHeight
                            );
                        } else {
                            scrollHeight = container.scrollHeight;
                        }

                        container.scrollTo({ top: scrollHeight, behavior: 'smooth' });
                    }
                } catch (e) {
                    // Fallback for older browsers or window object strictness
                    if (direction === 'top') {
                        container.scrollTop = 0;
                    } else {
                        if (container.scrollHeight) container.scrollTop = container.scrollHeight;
                    }
                }
            });
        };

        function initScrollButtons() {
            // Check if already exists
            if (document.getElementById('scroll-buttons-container')) return;

            // Create Container
            const container = document.createElement('div');
            container.id = 'scroll-buttons-container';
            container.className = 'fixed bottom-8 right-8 flex flex-col gap-2 z-50 transition-opacity duration-300 hidden'; // Default hidden
            container.innerHTML = `
                <button id="btn-scroll-top" class="p-3 bg-white/80 backdrop-blur text-slate-600 rounded-full shadow-lg hover:bg-white hover:text-blue-600 hover:scale-110 active:scale-90 transition-all border border-slate-100 ring-1 ring-slate-900/5 group" title="Lên đầu trang">
                    <i data-lucide="arrow-up" class="w-5 h-5"></i>
                </button>
                <button id="btn-scroll-bottom" class="p-3 bg-white/80 backdrop-blur text-slate-600 rounded-full shadow-lg hover:bg-white hover:text-blue-600 hover:scale-110 active:scale-90 transition-all border border-slate-100 ring-1 ring-slate-900/5 group" title="Xuống cuối trang">
                    <i data-lucide="arrow-down" class="w-5 h-5"></i>
                </button>
            `;
            document.body.appendChild(container); // Append to body

            // Re-init icons for new buttons
            lucide.createIcons();

            // Attach event listeners explicitly (more robust than onclick string)
            document.getElementById('btn-scroll-top').addEventListener('click', () => window.scrollToModule('top'));
            document.getElementById('btn-scroll-bottom').addEventListener('click', () => window.scrollToModule('bottom'));

            // Visibility Check Function
            const checkVisibility = () => {
                const businessSection = document.getElementById('section-business');
                const scrollBtns = document.getElementById('scroll-buttons-container');

                if (businessSection && !businessSection.classList.contains('hidden-section')) {
                    scrollBtns.classList.remove('hidden');
                } else {
                    scrollBtns.classList.add('hidden');
                }
            };

            // Observer
            const observer = new MutationObserver(checkVisibility);
            const businessSection = document.getElementById('section-business');
            if (businessSection) {
                observer.observe(businessSection, { attributes: true, attributeFilter: ['class'] });
            }

            // Initial Check
            checkVisibility();
        }

        function toggleAuthMode(mode) {
            const loginContainer = document.getElementById('login-form-container');
            const regContainer = document.getElementById('register-form-container');

            if (mode === 'register') {
                loginContainer.classList.add('hidden');
                regContainer.classList.remove('hidden');
                regContainer.classList.add('animate-fade-in');
            } else {
                regContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                loginContainer.classList.add('animate-fade-in');
            }
        }

        // --- Settings Functions ---
        function openSettingsModal() {
            document.getElementById('settings-modal').classList.remove('hidden');
            // Hide other dropdowns
            document.getElementById('user-profile-dropdown').classList.add('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
            document.getElementById('change-password-form').reset();
        }

        function confirmResetData() {
            if (confirm('⚠️ KHÔI PHỤC DỮ LIỆU?\n\nHành động này không thể hoàn tác.\nTất cả dữ liệu bệnh nhân sẽ bị xóa.\nTài khoản sẽ đăng xuất.')) {
                resetDemoData();
            }
        }

        // Settings Listeners
        document.getElementById('change-password-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const oldPass = document.getElementById('set-old-pass').value;
            const newPass = document.getElementById('set-new-pass').value;
            const session = JSON.parse(localStorage.getItem('mirabocaresync_session'));

            try {
                if (changePassword(session.user.username, oldPass, newPass)) {
                    showToast('Đổi mật khẩu thành công!', 'success');
                    closeSettingsModal();
                }
            } catch (e) {
                showToast(e.message, 'error');
            }
        });

        // --- User Profile Functions ---
        function openUserProfileModal() {
            const session = JSON.parse(localStorage.getItem('mirabocaresync_session'));
            if (!session) return;

            const profile = getUserProfile(session.user.username);
            if (!profile) return; // Should not happen

            // Populate Form
            document.getElementById('up-fullname').value = profile.fullName || '';
            document.getElementById('up-identifier').value = profile.identifier || ''; // Staff ID
            document.getElementById('up-dob').value = profile.birthDate || '';
            document.getElementById('up-gender').value = profile.gender || '';
            document.getElementById('up-phone').value = profile.telecomPhone || '';
            document.getElementById('up-email').value = profile.telecomEmail || '';
            document.getElementById('up-address').value = profile.address || '';
            document.getElementById('up-role').value = profile.roleTitle || '';
            document.getElementById('up-qualification').value = profile.qualificationCode || '';

            document.getElementById('user-profile-modal').classList.remove('hidden');
            document.getElementById('user-profile-dropdown').classList.add('hidden'); // Close dropdown
        }

        function closeUserProfileModal() {
            document.getElementById('user-profile-modal').classList.add('hidden');
        }

        document.getElementById('user-profile-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const session = JSON.parse(localStorage.getItem('mirabocaresync_session'));
            if (!session) return;

            const updateData = {
                fullName: document.getElementById('up-fullname').value,
                identifier: document.getElementById('up-identifier').value,
                birthDate: document.getElementById('up-dob').value,
                gender: document.getElementById('up-gender').value,
                telecomPhone: document.getElementById('up-phone').value,
                telecomEmail: document.getElementById('up-email').value,
                address: document.getElementById('up-address').value,
                roleTitle: document.getElementById('up-role').value,
                qualificationCode: document.getElementById('up-qualification').value
            };

            try {
                updateUserProfile(session.user.username, updateData);
                checkLogin(); // Refresh header UI
                showToast('Đã lưu hồ sơ nhân viên', 'success');
                closeUserProfileModal();
            } catch (e) {
                showToast('Lỗi khi lưu hồ sơ: ' + e.message, 'error');
            }
        });

        // --- Core ---
        window.onload = () => {
            lucide.createIcons();
            renderModuleTabs();
            renderPatientList();
            updateActivePatientDisplay();

            // Wait for DOM layout to stabilize before initializing scroll
            setTimeout(() => {
                initScrollButtons(); // Initialize helper
            }, 100);

            checkLogin(); // Check authentication

            // Pre-fill Remembered Username
            const rememberedUser = localStorage.getItem('mirabocaresync_remembered_username');
            if (rememberedUser) {
                document.getElementById('login-username').value = rememberedUser;
                document.getElementById('login-remember').checked = true;
                // Optional: Focus password field if username is filled
                document.getElementById('login-password').focus();
            }

            // Auth Form Listeners
            document.getElementById('login-form').addEventListener('submit', function (e) {
                e.preventDefault();
                const u = document.getElementById('login-username').value;
                const p = document.getElementById('login-password').value;
                const r = document.getElementById('login-remember').checked;
                try {
                    if (login(u, p, r)) {
                        checkLogin(); // update UI
                        showToast('Đăng nhập thành công!', 'success');
                    }
                } catch (err) {
                    showToast(err.message, 'error');
                }
            });

            document.getElementById('register-form').addEventListener('submit', function (e) {
                e.preventDefault();
                const fn = document.getElementById('reg-fullname').value;
                const u = document.getElementById('reg-username').value;
                const p = document.getElementById('reg-password').value;
                const cp = document.getElementById('reg-confirm-password').value;

                if (p !== cp) {
                    showToast('Mật khẩu không khớp!', 'error');
                    return;
                }

                try {
                    const user = register(fn, u, p);
                    showToast('Đăng ký thành công! Vui lòng đăng nhập.', 'success');
                    toggleAuthMode('login');
                    document.getElementById('login-username').value = u;
                    document.getElementById('login-password').focus();
                } catch (err) {
                    showToast(err.message, 'error');
                }
            });
        };

        // --- Mockup Helper: Clear All Data ---
        document.addEventListener('keydown', function (e) {
            // Ctrl+Shift+Delete (or Cmd+Shift+Delete on Mac)
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Delete') {
                e.preventDefault();

                if (confirm('⚠️ MOCKUP MODE: Xóa tất cả dữ liệu?\n\nĐiều này sẽ xóa:\n- Tất cả bệnh nhân\n- Tất cả dữ liệu module\n- Reset về trạng thái ban đầu\n\nBạn có chắc chắn?')) {
                    // Clear all localStorage data
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('mirabocaresync_')) {
                            keysToRemove.push(key);
                        }
                    }

                    keysToRemove.forEach(key => localStorage.removeItem(key));

                    showToast('✅ Đã xóa tất cả dữ liệu mockup!', 'success');

                    // Reload page to reset UI
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            }
        });

        function switchTab(tab) {
            document.getElementById('section-patients').classList.toggle('hidden-section', tab !== 'patients');
            document.getElementById('section-business').classList.toggle('hidden-section', tab !== 'business');
            document.getElementById('btn-patients').classList.toggle('sidebar-item-active', tab === 'patients');
            document.getElementById('btn-business').classList.toggle('sidebar-item-active', tab === 'business');

            if (tab === 'patients') {
                document.getElementById('header-title').innerText = 'Danh sách bệnh nhân';
                renderPatientList(); // Refresh patient list
            } else if (tab === 'business') {
                document.getElementById('header-title').innerText = 'Nghiệp vụ - ' + (getPatientById(getCurrentPatientId())?.fullName || 'Chưa chọn');
            }
        }

        function openPatient(id) {
            // Set the patient as active
            setCurrentPatientId(id);
            updateActivePatientDisplay();
            renderModuleTabs(); // Ensure checkmarks update

            switchTab('business');
            setActiveModule(1);
        }

        let currentFilter = 'all'; // Track current filter

        function renderPatientList(filter = currentFilter) {
            currentFilter = filter;

            // Update filter button styles
            document.getElementById('filter-all').className = filter === 'all'
                ? 'px-4 py-2 rounded-xl text-xs font-bold bg-blue-600 text-white'
                : 'px-4 py-2 rounded-xl text-xs font-bold bg-slate-100 text-slate-600 hover:bg-slate-200';
            document.getElementById('filter-active').className = filter === 'active'
                ? 'px-4 py-2 rounded-xl text-xs font-bold bg-blue-600 text-white'
                : 'px-4 py-2 rounded-xl text-xs font-bold bg-slate-100 text-slate-600 hover:bg-slate-200';
            document.getElementById('filter-inactive').className = filter === 'inactive'
                ? 'px-4 py-2 rounded-xl text-xs font-bold bg-blue-600 text-white'
                : 'px-4 py-2 rounded-xl text-xs font-bold bg-slate-100 text-slate-600 hover:bg-slate-200';

            // Populate patient table
            let patients = getAllPatients();

            // Apply filter
            if (filter === 'active') {
                patients = patients.filter(p => p.active !== false);
            } else if (filter === 'inactive') {
                patients = patients.filter(p => p.active === false);
            }

            const tbody = document.querySelector('#section-patients tbody');

            if (!tbody) return;

            if (patients.length === 0) {
                const message = filter === 'all'
                    ? 'Chưa có bệnh nhân nào. Click "Tạo bệnh nhân mới" để bắt đầu.'
                    : filter === 'active'
                        ? 'Không có bệnh nhân đang hoạt động.'
                        : 'Không có bệnh nhân đã vô hiệu.';

                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-10 py-8 text-center text-slate-400">
                            <p class="text-sm font-semibold">${message}</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = patients.map(patient => {
                const initial = patient.fullName.charAt(0).toUpperCase();
                const isActive = patient.active !== false;

                // Status badge
                let statusBadge = '';
                if (isActive) {
                    statusBadge = '<span class="px-4 py-1.5 bg-emerald-100 text-emerald-700 rounded-full text-[10px] font-black uppercase tracking-wider">Đang hoạt động</span>';
                } else if (patient.status === 'deceased') {
                    statusBadge = '<span class="px-4 py-1.5 bg-red-100 text-red-700 rounded-full text-[10px] font-black uppercase tracking-wider">Đã mất</span>';
                } else {
                    statusBadge = '<span class="px-4 py-1.5 bg-slate-100 text-slate-500 rounded-full text-[10px] font-black uppercase tracking-wider">Đã vô hiệu</span>';
                }

                // Action button
                let actionButton = '';
                if (isActive) {
                    actionButton = `
                        <button onclick="openDeactivateModal('${patient.id}')"
                            class="bg-slate-100 text-slate-600 px-4 py-2 rounded-xl text-xs font-black hover:bg-red-100 hover:text-red-600 transition-all mr-2">
                            <i data-lucide="archive" class="w-3 h-3 inline"></i> Vô hiệu hóa
                        </button>
                        <button onclick="openPatient('${patient.id}')"
                            class="bg-slate-900 text-white px-6 py-2 rounded-2xl text-xs font-black hover:bg-blue-600 transition-all shadow-lg shadow-slate-200">
                            Chi tiết hồ sơ
                        </button>
                    `;
                } else {
                    actionButton = `
                        <button onclick="confirmReactivate('${patient.id}')"
                            class="bg-emerald-100 text-emerald-700 px-4 py-2 rounded-xl text-xs font-black hover:bg-emerald-200 transition-all mr-2">
                            <i data-lucide="rotate-ccw" class="w-3 h-3 inline"></i> Kích hoạt lại
                        </button>
                        <button onclick="openPatient('${patient.id}')"
                            class="bg-slate-900 text-white px-6 py-2 rounded-2xl text-xs font-black hover:bg-blue-600 transition-all shadow-lg shadow-slate-200">
                            Chi tiết hồ sơ
                        </button>
                    `;
                }

                // Calculate Progress
                const status = JSON.parse(localStorage.getItem(`mirabocaresync_${patient.id}_status`) || '{}');
                // Filter specifically for module1..9 to be safe if other keys exist
                const validModules = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                const realCount = validModules.filter(id => status[`module${id}`]).length;
                const totalModules = 9;
                const progressPercent = Math.round((realCount / totalModules) * 100);

                return `
                    <tr class="hover:bg-slate-50/50 transition-all">
                        <td class="px-10 py-6 text-slate-800 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-2xl bg-blue-100 flex items-center justify-center text-blue-600 font-black">
                                ${initial}
                            </div>
                            <div>
                                <div class="font-bold">${patient.fullName}</div>
                                <div class="text-[10px] text-slate-400 font-bold mt-1 flex items-center gap-2">
                                     <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-emerald-500 rounded-full" style="width: ${progressPercent}%"></div>
                                     </div>
                                     <span>${realCount}/${totalModules}</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-10 py-6 text-slate-600">${patient.careLevel || 'Chăm sóc 1'}</td>
                        <td class="px-10 py-6">
                            ${statusBadge}
                        </td>
                        <td class="px-10 py-6 text-right">
                            ${actionButton}
                        </td>
                    </tr>
                `;
            }).join('');

            lucide.createIcons();
        }

        function filterPatients(status) {
            renderPatientList(status);
        }

        function openDeactivateModal(patientId) {
            document.getElementById('deactivate-patient-id').value = patientId;
            document.getElementById('deactivate-patient-modal').classList.remove('hidden');
        }

        function closeDeactivateModal() {
            document.getElementById('deactivate-patient-modal').classList.add('hidden');
            document.getElementById('deactivate-patient-form').reset();
        }

        function confirmReactivate(patientId) {
            const patient = getPatientById(patientId);
            if (!patient) return;

            if (confirm(`Kích hoạt lại bệnh nhân "${patient.fullName}" ?\n\nBệnh nhân sẽ được đánh dấu là đang hoạt động.`)) {
                if (reactivatePatient(patientId)) {
                    showToast(`Đã kích hoạt lại bệnh nhân: ${patient.fullName} `, 'success');
                    renderPatientList();
                }
            }
        }

        // Handle deactivation form submission
        document.addEventListener('DOMContentLoaded', function () {
            // Click outside to close Patient Switcher
            document.addEventListener('click', function (event) {
                const switcher = document.getElementById('patient-switcher-dropdown');
                const toggleBtn = event.target.closest('button[onclick*="patient-switcher-dropdown"]');
                const isInsideSwitcher = event.target.closest('#patient-switcher-dropdown');

                if (switcher && !switcher.classList.contains('hidden') && !toggleBtn && !isInsideSwitcher) {
                    switcher.classList.add('hidden');
                }
            });

            // Listen for module data save events to refresh progress
            window.addEventListener('module-data-saved', function () {
                renderModuleTabs();
            });

            document.getElementById('deactivate-patient-form')?.addEventListener('submit', function (e) {
                e.preventDefault();

                const patientId = document.getElementById('deactivate-patient-id').value;
                const reason = document.getElementById('deactivation-reason').value;
                const notes = document.getElementById('deactivation-notes').value;

                const patient = getPatientById(patientId);
                if (!patient) return;

                if (deactivatePatient(patientId, reason, notes)) {
                    showToast(`Đã vô hiệu hóa bệnh nhân: ${patient.fullName} `, 'success');
                    closeDeactivateModal();
                    renderPatientList();
                }
            });
        });

        function renderModuleTabs() {
            const container = document.getElementById('module-tabs');
            const patientId = getCurrentPatientId();
            const status = JSON.parse(localStorage.getItem(`mirabocaresync_${patientId}_status`) || '{}');

            container.innerHTML = modules.map(m => {
                const isComplete = status[`module${m.id}`];
                return `
                <button onclick="setActiveModule(${m.id})" id="module-btn-${m.id}" 
                    class="w-full flex items-center justify-between p-5 rounded-3xl border transition-all text-left bg-white border-slate-100 hover:border-blue-300 group shadow-sm relative overflow-hidden">
                    <div class="flex items-center gap-5 z-10">
                        <div class="module-icon-box p-3 rounded-2xl bg-slate-100 text-slate-500 transition-all">
                            <i data-lucide="${m.icon}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="text-[9px] font-black uppercase text-slate-400 tracking-widest mb-0.5">Nghiệp vụ 0${m.id}</p>
                            <p class="text-sm font-bold text-slate-700">${m.title.split(' (')[0]}</p>
                        </div>
                    </div>
                    ${isComplete ? `
                    <div class="bg-emerald-100 p-1.5 rounded-full mr-2 z-10">
                        <i data-lucide="check" class="w-4 h-4 text-emerald-600 font-bold"></i>
                    </div>
                    ` : ''}
                </button>
            `}).join('');
            lucide.createIcons();
        }

        function setActiveModule(id) {
            currentModuleId = id;
            document.getElementById('module-title').innerText = modules.find(m => m.id === id).title;

            modules.forEach(m => {
                const btn = document.getElementById(`module-btn-${m.id}`);
                const iconBox = btn.querySelector('.module-icon-box');
                if (m.id === id) {
                    btn.classList.add('active-module', 'border-blue-400', 'ring-[6px]', 'ring-blue-50');
                    iconBox.classList.add('bg-blue-600', 'text-white');
                    iconBox.classList.remove('bg-slate-100', 'text-slate-500');
                } else {
                    btn.classList.remove('active-module', 'border-blue-400', 'ring-[6px]', 'ring-blue-50');
                    iconBox.classList.remove('bg-blue-600', 'text-white');
                    iconBox.classList.add('bg-slate-100', 'text-slate-500');
                }
            });

            renderModuleView(id);
        }

        function renderModuleView(id) {
            const content = document.getElementById('module-content');

            // Check for modern render function first (e.g., renderModule7(content))
            const renderFuncName = 'renderModule' + id;
            if (typeof window[renderFuncName] === 'function') {
                content.innerHTML = ''; // Clear previous content
                window[renderFuncName](content);
                return;
            }

            // Fallback to legacy string content variable (e.g., module1Content)
            const contentVarName = 'module' + id + 'Content';

            if (window[contentVarName]) {
                content.innerHTML = window[contentVarName];

                // Initialize module logic if init function exists
                const initFuncName = 'initModule' + id;
                if (typeof window[initFuncName] === 'function') {
                    // Slight delay to ensure DOM is ready
                    setTimeout(() => window[initFuncName](), 0);
                }
            } else {
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-[400px] bg-slate-50 rounded-[48px] border-4 border-dashed border-slate-100">
                        <i data-lucide="package" class="w-16 h-16 text-slate-200 mb-6"></i>
                        <p class="font-black text-slate-400 uppercase tracking-[4px] text-xs">Module đang cập nhật dữ liệu</p>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function renderDashboard() {
            // Placeholder for dashboard logic if needed
        }
    </script>
</body>

</html>