<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Daycare - Bản Mockup</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- MediaPipe Tasks Vision -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest"></script>
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Demo Data Generator -->
    <script src="js/dummy_data_generator.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .active-module {
            border-color: #2563eb;
            background-color: #f8fafc;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .sidebar-item-active {
            background-color: #2563eb;
            color: white;
        }

        .hidden-section {
            display: none !important;
        }

        ::-webkit-scrollbar {
            width: 4px;
            /* Thin scrollbar */
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Animation cho mượt */
        /* Mobile Layour Adjustments */
        @media (max-width: 1024px) {

            /* Full Screen Patient Switcher */
            #patient-switcher-dropdown {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%);
                width: 90% !important;
                max-width: 400px;
                max-height: 80vh !important;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 100vmax rgba(0, 0, 0, 0.5) !important;
                z-index: 100 !important;
            }

            /* Hide Scroll Helpers (if any generic fixed buttons at bottom right) */
            /* Targeting buttons that are likely scroll arrows (usually small, near bottom edge) */
            /* Excluding known FAB containers if they are critical */
            button[class*="fixed"][class*="bottom-"][class*="w-8"],
            button[class*="fixed"][class*="bottom-"][class*="w-10"],
            .scroll-helper-arrow {
                display: none !important;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }



        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);

            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* PREMIUM IOS BUTTON SYSTEM */
        .btn-ios {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            /* Pill shape */
            font-weight: 700;
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            box-sizing: border-box;
        }

        /* Small Variant */
        .btn-ios-sm {
            padding: 0.4rem 1rem;
            font-size: 0.75rem;
        }

        /* Scale Effect on Active/Click */
        .btn-ios:active {
            transform: scale(0.96);
        }

        /* Primary: Blue Gradient + Colored Shadow */
        .btn-ios-primary {
            background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: none;
        }

        .btn-ios-primary::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center top, rgba(255, 255, 255, 0.3) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn-ios-primary:hover {
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.45),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-ios-primary:hover::after {
            opacity: 1;
        }

        /* Secondary: White Glassy + Subtle Shadow */
        .btn-ios-secondary {
            background: white;
            color: #475569;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .btn-ios-secondary:hover {
            background-color: #f8fafc;
            color: #1e293b;
            border-color: #cbd5e1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        /* PRINT MODE STYLES (PDF Generation) */
        .print-mode {
            width: 210mm !important;
            max-width: 210mm !important;
            min-height: 297mm;
            background: white !important;
            margin: 0 auto !important;
            padding: 20px !important;
            box-shadow: none !important;
        }

        .print-mode .print-section {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
            margin-bottom: 24px;
        }

        /* Force gradients to render correctly in capture */
        .print-mode * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    </style>
    <link rel="stylesheet" href="print.css">
    <!-- PDF Hidden Container (Off-screen) -->
    <div id="pdf-hidden-container"
        style="position: fixed; left: -9999px; top: 0; width: 210mm; background: white; z-index: -1;"></div>

    <style>
        /* Medical Report Print Styles */
        .medical-report {
            font-family: 'Times New Roman', Times, serif;
            /* Professional Serif */
            color: #000;
            line-height: 1.5;
            width: 100%;
        }

        .medical-report h1 {
            font-size: 24pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .medical-report h2 {
            font-size: 16pt;
            font-weight: bold;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
            text-transform: uppercase;
        }

        .medical-report h3 {
            font-size: 14pt;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #333;
        }

        .medical-report p {
            font-size: 12pt;
            margin-bottom: 10px;
            text-align: justify;
        }

        /* Medical Tables */
        .medical-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 11pt;
        }

        .medical-table th,
        .medical-table td {
            border: 1px solid #333;
            padding: 8px 12px;
            text-align: left;
            vertical-align: middle;
        }

        .medical-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-transform: uppercase;
        }

        .medical-table td.center {
            text-align: center;
        }

        .medical-table td.right {
            text-align: right;
        }

        .medical-table td.bold {
            font-weight: bold;
        }

        /* Images */
        .report-image-container {
            text-align: center;
            margin: 20px 0;
            border: 1px solid #ccc;
            padding: 10px;
            background: #fff;
        }

        .report-image {
            max-height: 500px;
            max-width: 100%;
            object-fit: contain;
        }

        /* Page Break Utility */
        .page-break {
            page-break-before: always;
        }

        /* Utility */
        .text-center {
            text-align: center;
        }

        .mt-4 {
            margin-top: 20px;
        }

        .mb-4 {
            margin-bottom: 20px;
        }
    </style>
</head>

<body class="bg-[#F2F2F7] text-[#000000] h-screen flex overflow-hidden selection:bg-[#007AFF]/20">

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden glass backdrop-blur-sm transition-opacity"></div>

    <!-- Sidebar (iPadOS Stylized) -->
    <aside id="main-sidebar"
        class="fixed inset-y-0 left-0 z-40 w-80 lg:w-20 bg-[#F2F2F7] border-r border-[#3C3C43]/10 flex flex-col text-slate-900 transition-all duration-300 transform -translate-x-full lg:translate-x-0 lg:static group">
        <!-- Header -->
        <div class="px-4 pt-12 pb-4 flex items-center justify-between gap-3 min-h-[5.5rem] relative">
            <div class="flex items-center gap-3 overflow-hidden whitespace-nowrap">
                <div
                    class="w-10 h-10 flex items-center justify-center shrink-0 bg-blue-600 rounded-xl shadow-lg shadow-blue-500/20">
                    <i data-lucide="activity" class="text-white w-6 h-6"></i>
                </div>
                <!-- Logo Text (Hidden on Desktop Collapsed) -->
                <h1
                    class="text-2xl font-bold tracking-tight text-[#000000] block lg:hidden group-[.is-expanded]:lg:block transition-opacity duration-300">
                    MCare</h1>
            </div>

            <!-- Close button for mobile -->
            <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-full bg-slate-200 text-slate-500">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

        </div>

        <nav class="flex-1 px-3 space-y-2 overflow-y-auto overflow-x-hidden pt-4">

            <!-- Group Header -->
            <div
                class="mt-4 mb-2 px-1 text-[10px] font-bold text-slate-400 uppercase tracking-wide truncate block lg:hidden group-[.is-expanded]:lg:block transition-opacity delay-75">
                Quản lý</div>

            <button onclick="switchTab('patients')" id="btn-patients" title="Danh sách bệnh nhân"
                class="w-full flex items-center gap-3 px-3 py-3 rounded-lg transition-all text-[17px] font-medium bg-[#007AFF]/10 text-[#007AFF] overflow-hidden whitespace-nowrap group/item">
                <div class="w-6 h-6 flex justify-center shrink-0"><i data-lucide="users" class="w-6 h-6"></i></div>
                <span class="block lg:hidden group-[.is-expanded]:lg:block transition-opacity duration-300">Danh sách
                    bệnh nhân</span>
            </button>
            <button onclick="switchTab('business')" id="btn-business" title="Nghiệp vụ"
                class="w-full flex items-center gap-3 px-3 py-3 rounded-lg transition-all text-[17px] font-medium text-slate-700 hover:bg-slate-200/50 overflow-hidden whitespace-nowrap group/item">
                <div class="w-6 h-6 flex justify-center shrink-0"><i data-lucide="clipboard-list" class="w-6 h-6"></i>
                </div>
                <span class="block lg:hidden group-[.is-expanded]:lg:block transition-opacity duration-300">Nghiệp
                    vụ</span>
            </button>

            <!-- Group Header -->
            <div
                class="mt-8 mb-2 px-1 text-[10px] font-bold text-slate-400 uppercase tracking-wide truncate block lg:hidden group-[.is-expanded]:lg:block transition-opacity delay-75">
                Hệ thống</div>

            <button onclick="openSettingsModal()" title="Cài đặt"
                class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-[17px] font-medium text-slate-700 hover:bg-slate-200/50 overflow-hidden whitespace-nowrap group/item">
                <div class="w-6 h-6 flex justify-center shrink-0"><i data-lucide="settings" class="w-6 h-6"></i></div>
                <span class="block lg:hidden group-[.is-expanded]:lg:block transition-opacity duration-300">Cài
                    đặt</span>
            </button>
            <button onclick="generateDummyData()" title="Tạo dữ liệu mẫu"
                class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-[17px] font-medium text-amber-600 hover:bg-amber-50 overflow-hidden whitespace-nowrap group/item border-t border-slate-100 mt-4 pt-4">
                <div class="w-6 h-6 flex justify-center shrink-0"><i data-lucide="database" class="w-6 h-6"></i></div>
                <span class="block lg:hidden group-[.is-expanded]:lg:block transition-opacity duration-300">Tạo Dữ liệu
                    Mẫu</span>
            </button>
        </nav>

        <!-- Footer (Toggle) -->
        <div class="p-4 border-t border-[#3C3C43]/10 flex justify-center">
            <button onclick="toggleDesktopSidebar()" title="Mở rộng/Thu gọn"
                class="hidden lg:flex items-center justify-center p-2 rounded-lg text-slate-400 hover:text-blue-600 hover:bg-slate-100 transition-colors w-full group/toggle">
                <i data-lucide="chevron-right" id="sidebar-toggle-icon" class="w-6 h-6 transition-transform"></i>
            </button>
        </div>

        <!-- Copyright -->
        <div class="pb-4 text-center overflow-hidden whitespace-nowrap">
            <p
                class="text-[10px] text-slate-300 font-semibold block lg:hidden group-[.is-expanded]:lg:block transition-opacity">
                © 2026 MiraboCareSync</p>
            <p class="text-[10px] text-slate-300 font-bold hidden lg:block group-[.is-expanded]:lg:hidden">©</p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        <!-- Header -->
        <!-- Header (iOS Navigation Bar Style) -->
        <header
            class="h-[52px] md:h-16 bg-[#F2F2F7]/90 backdrop-blur-xl border-b border-[#3C3C43]/10 flex items-center justify-between px-4 z-20 sticky top-0 md:bg-[#F2F2F7] shrink-0">
            <div class="flex items-center gap-3">
                <!-- Mobile Menu Button -->
                <button onclick="toggleSidebar()" class="lg:hidden text-[#007AFF] active:opacity-50 transition-opacity">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <div class="md:hidden">
                    <h2 class="text-[17px] font-semibold text-[#000000]">Danh sách</h2>
                </div>
            </div>

            <div class="flex items-center gap-4 relative">
                <button id="user-profile-btn" onclick="toggleUserProfile()"
                    class="flex items-center gap-3 hover:bg-slate-100 p-1.5 rounded-xl transition-colors group outline-none">
                    <div class="text-right hidden md:block">
                        <p id="header-user-name" class="text-sm font-bold text-slate-900 group-hover:text-blue-700">
                            Administrator</p>
                        <p id="header-user-role" class="text-xs text-slate-500 font-medium">Quản trị viên</p>
                    </div>
                    <div id="header-user-avatar"
                        class="w-9 h-9 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold shadow-md shadow-blue-200 ring-2 ring-white text-sm">
                        A
                    </div>
                </button>
                <!-- User Dropdown (Simplified) -->
                <div id="user-profile-dropdown"
                    class="hidden absolute right-0 top-14 w-64 bg-white/95 backdrop-blur-xl rounded-xl shadow-2xl border border-slate-100 z-50 p-0 overflow-hidden text-center divide-y divide-slate-100 animate-fade-in">
                    <button onclick="openUserProfileModal()"
                        class="w-full py-3 text-[17px] text-[#007AFF] active:bg-slate-100">Hồ sơ</button>
                    <button onclick="logout()"
                        class="w-full py-3 text-[17px] text-rose-500 font-medium active:bg-slate-100">Đăng xuất</button>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto px-0 md:px-8 py-0 md:py-6 bg-[#F2F2F7]">

            <!-- Patient List Section -->
            <section id="section-patients" class="max-w-7xl mx-auto flex flex-col h-full md:h-auto animate-fade-in">

                <!-- Desktop Title (Large Title) -->
                <div class="hidden md:flex items-end justify-between mb-4">
                    <h1 class="text-[34px] font-bold tracking-tight text-[#000000]">Danh sách</h1>
                    <div class="flex items-center gap-4">
                        <!-- Search Input -->
                        <div class="relative hidden md:block">
                            <i data-lucide="search"
                                class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input type="text" id="patient-search-input" oninput="searchPatients(this.value)"
                                placeholder="Tìm kiếm bệnh nhân..."
                                class="pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all w-64">
                        </div>
                        <button onclick="openCreatePatientModal()"
                            class="text-[#007AFF] text-[17px] font-normal flex items-center gap-1 active:opacity-50 hover:bg-white/50 px-3 py-1.5 rounded-xl transition-all">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <div
                    class="bg-transparent md:bg-white md:rounded-xl md:shadow-sm md:overflow-hidden flex-col h-full md:h-auto border-[#3C3C43]/10">
                    <!-- iOS Mobile Toolbar (Segmented) -->
                    <div
                        class="p-3 bg-[#F2F2F7] md:bg-transparent md:border-b border-[#3C3C43]/10 sticky top-0 z-10 transition-all backdrop-blur-md bg-opacity-90">
                        <div class="flex p-0.5 bg-[#767680]/15 rounded-md w-full md:max-w-md mx-auto md:mx-0">
                            <button onclick="filterPatients('all')" id="filter-all"
                                class="flex-1 py-1 rounded-sm text-[13px] font-semibold text-center shadow-sm bg-white text-black">
                                Tất cả
                            </button>
                            <button onclick="filterPatients('active')" id="filter-active"
                                class="flex-1 py-1 rounded-sm text-[13px] font-medium text-center text-slate-500">
                                Hoạt động
                            </button>
                            <button onclick="filterPatients('inactive')" id="filter-inactive"
                                class="flex-1 py-1 rounded-sm text-[13px] font-medium text-center text-slate-500">
                                Vô hiệu
                            </button>
                        </div>
                    </div>

                    <!-- Desktop Create Button (Mobile uses header + icon) -->

                    <!-- Mobile List View (Inset Grouped mimic) -->
                    <div id="mobile-patient-list" class="md:hidden pt-2 px-4 space-y-4 pb-20">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Desktop Table View -->
                    <div class="hidden md:block overflow-x-auto flex-1 bg-white">
                        <table class="w-full text-left">
                            <thead class="bg-white text-slate-400 text-[10px] uppercase font-black tracking-widest">
                                <tr>
                                    <th class="px-4 md:px-6 lg:px-10 py-6 whitespace-nowrap">Tên Bệnh nhân</th>
                                    <th class="px-4 md:px-6 lg:px-10 py-6 whitespace-nowrap">Mức độ</th>
                                    <th class="px-4 md:px-6 lg:px-10 py-6 whitespace-nowrap">Tiến độ</th>
                                    <th class="px-4 md:px-6 lg:px-10 py-6 whitespace-nowrap">Trạng thái</th>
                                    <th class="px-4 md:px-6 lg:px-10 py-6 text-right whitespace-nowrap">Hành động</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50 text-sm font-medium">
                                <tr class="hover:bg-slate-50/50 transition-all">
                                    <td
                                        class="px-4 md:px-6 lg:px-10 py-6 text-slate-800 flex items-center gap-4 whitespace-nowrap">
                                        <div
                                            class="w-10 h-10 rounded-2xl bg-blue-100 flex items-center justify-center text-blue-600 font-black shrink-0">
                                            A</div>
                                        Nguyễn Văn A
                                    </td>
                                    <td class="px-4 md:px-6 lg:px-10 py-6 text-slate-600">Chăm sóc 2</td>
                                    <td class="px-4 md:px-6 lg:px-10 py-6"><span
                                            class="px-4 py-1.5 bg-emerald-100 text-emerald-700 rounded-full text-[10px] font-black uppercase tracking-wider">Đang
                                            hoạt động</span></td>
                                    <td class="px-4 md:px-6 lg:px-10 py-6 text-right">
                                        <button onclick="openPatient(1)"
                                            class="btn-ios btn-ios-primary btn-ios-sm shadow-blue-200">Chi
                                            tiết hồ sơ</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Business Processes Section -->
            <section id="section-business" class="hidden-section max-w-7xl mx-auto space-y-8 animate-fade-in">
                <!-- Profile Card -->
                <div
                    class="bg-white p-4 md:p-8 rounded-[40px] border shadow-sm flex flex-col md:flex-row gap-8 items-center border-slate-100 relative">
                    <div id="patient-avatar"
                        class="w-24 h-24 rounded-[32px] bg-gradient-to-br from-blue-600 to-indigo-700 flex items-center justify-center text-white text-4xl font-black shadow-2xl shadow-blue-500/20 shrink-0">
                        ?
                    </div>
                    <div class="flex-1 text-center md:text-left">
                        <div class="flex items-center justify-center md:justify-start gap-4 mb-2">
                            <h1 id="patient-detail-name" class="text-3xl font-black text-slate-800 tracking-tight">Chưa
                                chọn bệnh nhân</h1>
                            <!-- Patient Switcher Dropdown (Hidden trigger, styled as button) -->
                            <div class="relative group">
                                <button
                                    onclick="document.getElementById('patient-switcher-dropdown').classList.toggle('hidden')"
                                    class="p-2 bg-slate-50 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all"
                                    title="Chuyển bệnh nhân">
                                    <i data-lucide="arrow-left-right" class="w-5 h-5"></i>
                                </button>
                                <div id="patient-switcher-dropdown"
                                    class="hidden absolute top-full left-0 mt-2 w-64 bg-white rounded-2xl shadow-xl border border-slate-100 z-50 overflow-hidden max-h-60 overflow-y-auto animate-fade-in">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>

                        <div
                            class="flex flex-wrap gap-4 text-[11px] font-bold text-slate-400 justify-center md:justify-start">
                            <span id="patient-detail-care-level"
                                class="bg-slate-100 px-3 py-1 rounded-lg text-slate-600 uppercase">---</span>
                            <span id="patient-detail-id">ID: ---</span>
                            <span id="patient-detail-age-gender">--- • ---</span>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="switchTab('patients')" class="btn-ios btn-ios-secondary">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            <span>Quay lại danh sách</span></button>
                    </div>
                </div>

                <!-- 9 Modules Workspace -->
                <div class="flex flex-col lg:flex-row gap-10 pb-16 relative">
                    <!-- Nav Tabs (Mobile: Dashboard View) -->
                    <div id="mobile-dashboard-view" class="w-full lg:w-80 space-y-3 transition-all duration-300">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[3px] mb-6 pl-4">9 Nghiệp vụ
                            quản lý</p>
                        <div id="module-tabs" class="space-y-3">
                            <!-- Module items via JS -->
                        </div>
                    </div>

                    <!-- Work Area (Mobile: Detail View) -->
                    <div id="mobile-detail-view"
                        class="hidden lg:block flex-1 bg-white rounded-[24px] border border-slate-100 shadow-sm overflow-hidden min-h-[600px] flex flex-col relative transition-all duration-300">

                        <!-- Mobile Back Navigation -->
                        <div
                            class="lg:hidden p-4 border-b border-slate-50 flex items-center gap-3 bg-white sticky top-0 z-20">
                            <button onclick="toggleMobileView('dashboard')"
                                class="p-2 -ml-2 text-slate-500 hover:text-blue-600 hover:bg-slate-50 rounded-xl transition-all flex items-center gap-2">
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                                <span class="text-sm font-bold">Quay lại danh sách</span>
                            </button>
                        </div>

                        <!-- Floating Module Actions -->
                        <div id="module-actions"
                            class="relative top-0 right-0 p-4 flex justify-end gap-2 z-10 md:absolute md:top-5 md:right-10 md:p-0">
                        </div>

                        <div id="module-content" class="p-4 md:p-10 flex-1 overflow-y-auto min-h-[400px]">
                            <!-- Dynamic Content -->
                            <div class="flex flex-col items-center justify-center h-full text-center p-10 opacity-50">
                                <i data-lucide="layout-grid" class="w-16 h-16 text-slate-200 mb-4"></i>
                                <p class="text-slate-400 font-bold">Chọn một nghiệp vụ để bắt đầu</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Patient Creation Modal -->
    <div id="create-patient-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[40px] shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-8 border-b border-slate-100">
                <h2 class="text-2xl font-black text-slate-800">Tạo bệnh nhân mới</h2>
                <p class="text-sm text-slate-500 mt-1">Nhập thông tin cơ bản của bệnh nhân</p>
            </div>

            <form id="create-patient-form" class="p-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Họ và tên <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="new-patient-name" required
                            class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium"
                            placeholder="Nguyễn Văn A">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ngày sinh <span
                                class="text-red-500">*</span></label>
                        <input type="date" id="new-patient-dob" required
                            class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Giới tính <span
                                class="text-red-500">*</span></label>
                        <select id="new-patient-gender" required
                            class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium">
                            <option value="">Chọn giới tính</option>
                            <option value="male">Nam</option>
                            <option value="female">Nữ</option>
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Mức chăm sóc</label>
                        <select id="new-patient-care-level"
                            class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium">
                            <option value="Chăm sóc 1">Chăm sóc 1</option>
                            <option value="Chăm sóc 2">Chăm sóc 2</option>
                            <option value="Chăm sóc 3">Chăm sóc 3</option>
                            <option value="Chăm sóc 4">Chăm sóc 4</option>
                            <option value="Chăm sóc 5">Chăm sóc 5</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeCreatePatientModal()"
                        class="flex-1 px-6 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all">
                        Hủy
                    </button>
                    <button type="submit"
                        class="flex-1 px-6 py-4 bg-blue-600 text-white rounded-2xl font-black text-sm hover:bg-blue-700 shadow-xl shadow-blue-500/20 transition-all">
                        Tạo bệnh nhân
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Patient Deactivation Modal -->
    <div id="deactivate-patient-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <!-- ... existing modal content ... -->
        <div class="bg-white rounded-[40px] shadow-2xl max-w-lg w-full">
            <div class="p-8 border-b border-slate-100">
                <h2 class="text-2xl font-black text-slate-800">Vô hiệu hóa bệnh nhân</h2>
                <p class="text-sm text-slate-500 mt-1">Bệnh nhân sẽ được đánh dấu là không hoạt động</p>
            </div>

            <form id="deactivate-patient-form" class="p-8 space-y-6">
                <input type="hidden" id="deactivate-patient-id">

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Lý do vô hiệu hóa <span
                            class="text-red-500">*</span></label>
                    <select id="deactivation-reason" required
                        class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium">
                        <option value="">Chọn lý do</option>
                        <option value="discharged">Đã xuất viện</option>
                        <option value="transferred">Chuyển viện</option>
                        <option value="deceased">Đã mất</option>
                        <option value="other">Lý do khác</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Ghi chú</label>
                    <textarea id="deactivation-notes" rows="3"
                        class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium resize-none"
                        placeholder="Thông tin bổ sung (không bắt buộc)"></textarea>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeDeactivateModal()"
                        class="flex-1 px-6 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all">
                        Hủy
                    </button>
                    <button type="submit"
                        class="flex-1 px-6 py-4 bg-red-600 text-white rounded-2xl font-black text-sm hover:bg-red-700 shadow-xl shadow-red-500/20 transition-all">
                        Vô hiệu hóa
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Login/Register Overlay -->
    <div id="login-overlay"
        class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center transition-all duration-500">
        <!-- Background Decor -->
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-blue-900 to-slate-900 opacity-90">
            </div>
            <div
                class="absolute -top-1/2 -left-1/2 w-[100rem] h-[100rem] bg-blue-600/20 rounded-full blur-3xl animate-pulse">
            </div>
            <div
                class="absolute -bottom-1/2 -right-1/2 w-[100rem] h-[100rem] bg-indigo-600/20 rounded-full blur-3xl animate-pulse delay-1000">
            </div>
        </div>

        <!-- Login Card -->
        <div
            class="relative bg-white/95 backdrop-blur-xl p-10 rounded-[40px] shadow-2xl w-full max-w-md mx-4 border border-white/20">

            <!-- Login Form -->
            <div id="login-form-container" class="space-y-8">
                <div class="text-center space-y-3">
                    <div
                        class="bg-blue-600 w-16 h-16 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-blue-500/30 mb-6">
                        <i data-lucide="activity" class="text-white w-8 h-8"></i>
                    </div>
                    <h1 class="text-3xl font-black text-slate-900 tracking-tight">Chào mừng trở lại</h1>
                    <p class="text-slate-500 font-medium">Đăng nhập vào hệ thống MCare</p>
                </div>

                <form id="login-form" class="space-y-5">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">Tên đăng
                            nhập</label>
                        <div class="relative">
                            <i data-lucide="user"
                                class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="text" id="login-username" required placeholder="admin"
                                class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-bold text-slate-700 placeholder:font-normal">
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">Mật khẩu</label>
                        <div class="relative">
                            <i data-lucide="lock"
                                class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="password" id="login-password" required placeholder="••••••"
                                class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-bold text-slate-700 placeholder:font-normal">
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="login-remember"
                                class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-xs font-bold text-slate-500">Ghi nhớ đăng nhập</span>
                        </label>
                    </div>

                    <button type="submit"
                        class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black text-sm shadow-xl shadow-blue-500/20 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                        Đăng nhập
                    </button>
                </form>

                <div class="text-center pt-2">
                    <p class="text-sm text-slate-500 font-bold">
                        Chưa có tài khoản?
                        <button onclick="toggleAuthMode('register')"
                            class="text-blue-600 hover:text-blue-700 hover:underline">Tạo tài khoản mới</button>
                    </p>
                </div>
            </div>

            <!-- Register Form (Hidden by default) -->
            <div id="register-form-container" class="hidden space-y-8">
                <div class="text-center space-y-3">
                    <div
                        class="bg-emerald-500 w-16 h-16 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-emerald-500/30 mb-6">
                        <i data-lucide="user-plus" class="text-white w-8 h-8"></i>
                    </div>
                    <h1 class="text-3xl font-black text-slate-900 tracking-tight">Tạo tài khoản</h1>
                    <p class="text-slate-500 font-medium">Đăng ký tài khoản nhân viên mới</p>
                </div>

                <form id="register-form" class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider pl-1">Họ và
                            tên</label>
                        <input type="text" id="reg-fullname" required placeholder="Nguyễn Văn A"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 outline-none transition-all font-bold text-slate-700 placeholder:font-normal">
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider pl-1">Tên đăng
                            nhập</label>
                        <input type="text" id="reg-username" required placeholder="user123"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 outline-none transition-all font-bold text-slate-700 placeholder:font-normal">
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider pl-1">Mật
                            khẩu</label>
                        <input type="password" id="reg-password" required placeholder="••••••"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 outline-none transition-all font-bold text-slate-700 placeholder:font-normal">
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider pl-1">Nhập lại mật
                            khẩu</label>
                        <input type="password" id="reg-confirm-password" required placeholder="••••••"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-2xl focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 outline-none transition-all font-bold text-slate-700 placeholder:font-normal">
                    </div>

                    <button type="submit"
                        class="w-full py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-black text-sm shadow-xl shadow-emerald-500/20 transition-all transform hover:scale-[1.02] active:scale-[0.98] mt-2">
                        Đăng ký
                    </button>
                </form>

                <div class="text-center pt-2">
                    <p class="text-sm text-slate-500 font-bold">
                        Đã có tài khoản?
                        <button onclick="toggleAuthMode('login')"
                            class="text-blue-600 hover:text-blue-700 hover:underline">Đăng nhập</button>
                    </p>
                </div>
            </div>

        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
        <div class="bg-white rounded-[40px] shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-black text-slate-800">Cài đặt</h2>
                    <p class="text-sm text-slate-500 mt-1">Tùy chỉnh hệ thống</p>
                </div>
                <button onclick="closeSettingsModal()"
                    class="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-all">
                    <i data-lucide="x" class="w-5 h-5 text-slate-600"></i>
                </button>
            </div>

            <div class="p-8 space-y-8">
                <!-- Theme & Language (Mockup) -->
                <section class="space-y-4">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Giao diện</h3>
                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <div class="flex items-center gap-3">
                            <i data-lucide="moon" class="w-5 h-5 text-slate-600"></i>
                            <span class="font-bold text-slate-700 text-sm">Chế độ tối (Dark Mode)</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" disabled class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                            </div>
                        </label>
                    </div>
                    <p class="text-[10px] text-slate-400 italic text-center">* Tính năng đang phát triển</p>
                </section>

                <!-- Change Password -->
                <section class="space-y-4">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Bảo mật</h3>
                    <form id="change-password-form" class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Mật khẩu hiện tại</label>
                            <input type="password" id="set-old-pass" required
                                class="w-full px-4 py-2 rounded-xl border border-slate-200 text-sm font-bold shadow-sm focus:ring-2 focus:ring-blue-100 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Mật khẩu mới</label>
                            <input type="password" id="set-new-pass" required
                                class="w-full px-4 py-2 rounded-xl border border-slate-200 text-sm font-bold shadow-sm focus:ring-2 focus:ring-blue-100 outline-none">
                        </div>
                        <button type="submit"
                            class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold text-xs hover:bg-slate-900 transition-all">
                            Đổi mật khẩu
                        </button>
                    </form>
                </section>

                <!-- Data Management -->
                <section class="space-y-4">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Dữ liệu</h3>
                    <div class="p-4 bg-red-50 rounded-2xl border border-red-100 space-y-3">
                        <div class="flex items-center gap-3 text-red-700">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            <span class="font-bold text-sm">Reset dữ liệu Demo</span>
                        </div>
                        <p class="text-xs text-red-600/80">Xóa toàn bộ bệnh nhân và dữ liệu đã nhập. Tài khoản sẽ đăng
                            xuất.</p>
                        <button onclick="confirmResetData()"
                            class="w-full py-3 bg-white border border-red-200 text-red-600 rounded-xl font-bold text-xs hover:bg-red-600 hover:text-white transition-all">
                            Xóa dữ liệu & Reset
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="user-profile-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-end md:items-center justify-center p-0 md:p-4">
        <div
            class="bg-white rounded-t-[32px] md:rounded-[40px] shadow-2xl w-full md:max-w-2xl max-h-[90vh] h-[85vh] md:h-auto overflow-hidden flex flex-col">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center bg-indigo-50/50">
                <div>
                    <h2 class="text-2xl font-black text-indigo-900">Hồ sơ nhân viên</h2>
                    <p class="text-sm text-indigo-500 mt-1 font-bold">Thông tin cá nhân & chuyên môn</p>
                </div>
                <button onclick="closeUserProfileModal()"
                    class="p-2 bg-white rounded-full hover:bg-slate-100 transition-all border border-slate-100 shadow-sm">
                    <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                </button>
            </div>

            <form id="user-profile-form" class="p-8 space-y-8 overflow-y-auto flex-1 overscroll-contain">
                <!-- Identity Section -->
                <section>
                    <h3
                        class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i data-lucide="badge-check" class="w-4 h-4"></i> Định danh
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Mã nhân viên (Identifier)</label>
                            <input type="text" id="up-identifier"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Họ và tên</label>
                            <input type="text" id="up-fullname" required
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                    </div>
                </section>

                <!-- Demographics -->
                <section>
                    <h3
                        class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i data-lucide="user" class="w-4 h-4"></i> Thông tin cá nhân
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Ngày sinh</label>
                            <input type="date" id="up-dob"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Giới tính</label>
                            <select id="up-gender"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                                <option value="">-- Chọn --</option>
                                <option value="male">Nam</option>
                                <option value="female">Nữ</option>
                                <option value="other">Khác</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Contact -->
                <section>
                    <h3
                        class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i data-lucide="phone" class="w-4 h-4"></i> Liên hệ
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Số điện thoại</label>
                            <input type="tel" id="up-phone"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Email</label>
                            <input type="email" id="up-email"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-600 mb-1">Địa chỉ</label>
                            <input type="text" id="up-address"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                    </div>
                </section>

                <!-- Qualification -->
                <section>
                    <h3
                        class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i data-lucide="award" class="w-4 h-4"></i> Chuyên môn
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Vai trò / Chức danh</label>
                            <input type="text" id="up-role" placeholder="VD: Điều dưỡng trưởng"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-1">Chứng chỉ hành nghề</label>
                            <input type="text" id="up-qualification" placeholder="VD: CCHN-123456"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm font-bold focus:ring-2 focus:ring-indigo-100 outline-none transition-all">
                        </div>
                    </div>
                </section>

                <div class="pt-4 border-t border-slate-100 flex justify-end gap-3">
                    <button type="button" onclick="closeUserProfileModal()"
                        class="px-6 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-xs hover:bg-slate-200 transition-all">
                        Hủy bỏ
                    </button>
                    <button type="submit"
                        class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold text-xs hover:bg-indigo-700 shadow-xl shadow-indigo-500/20 transition-all">
                        Lưu hồ sơ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="common.js"></script>
    <script src="geometryUtils.js"></script>
    <script src="postureUtils.js"></script>
    <script src="module1.js"></script>
    <script src="module2.js"></script>
    <script src="module3.js"></script>
    <script src="module4.js"></script>
    <script src="module5.js"></script>
    <script src="module6.js"></script>
    <script src="module7.js"></script>
    <script src="module9.js"></script>
    <script src="module8.js"></script>
    <script src="module10.js"></script>

    <script>
        // --- State ---
        let currentModuleId = 1;
        let radarChartInstance = null;
        let trendChartInstance = null;
        let timelineChartInstance = null;

        const modules = [
            { id: 1, title: 'Face Sheet (Cơ bản)', icon: 'user' },
            { id: 2, title: 'Họp Phụ Trách', icon: 'message-square' },
            { id: 3, title: 'Đánh giá ADL/IADL', icon: 'clipboard-list' },
            { id: 4, title: 'Sở thích & Quan tâm', icon: 'heart' },
            { id: 5, title: 'Kế hoạch (Plan)', icon: 'calendar-days' },
            { id: 10, title: 'Đánh giá tư thế', icon: 'scan-line', code: '06-1' },
            { id: 6, title: 'Thành phần Cơ (SMI)', icon: 'bar-chart-3', code: '06-2' },
            { id: 7, title: 'Chức năng vận động', icon: 'zap', code: '06-3' },
            { id: 8, title: 'Bảo mật & Đồng ý', icon: 'shield-check' },
            { id: 9, title: 'Khảo sát Nhà ở', icon: 'home' }
        ];

        // --- Patient Management Functions ---

        function updateActivePatientDisplay() {
            // Also update patient detail profile
            updatePatientDetailProfile();
            renderPatientSwitcher();
        }

        function renderPatientSwitcher(filterText = '') {
            const patients = getAllPatients();
            const activeId = getCurrentPatientId();
            const container = document.getElementById('patient-switcher-dropdown');
            if (!container) return;

            // Filter patients if search text exists
            const filteredPatients = filterText
                ? patients.filter(p => p.fullName.toLowerCase().includes(filterText.toLowerCase()) || p.id.toLowerCase().includes(filterText.toLowerCase()))
                : patients;

            const listHtml = filteredPatients.map(p => `
                <button onclick="switchToPatient('${p.id}'); document.getElementById('patient-switcher-dropdown').classList.add('hidden');" 
                    class="w-full text-left px-4 py-3 hover:bg-slate-50 flex items-center gap-3 transition-colors border-b last:border-0 border-slate-50 ${p.id === activeId ? 'bg-blue-50/50' : ''}">
                    <div class="w-8 h-8 rounded-lg ${p.id === activeId ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-500'} flex items-center justify-center font-bold text-xs">
                        ${p.fullName.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1">
                        <p class="text-xs font-bold text-slate-700">${p.fullName}</p>
                        <p class="text-[9px] text-slate-400 uppercase">ID: ${p.id}</p>
                    </div>
                    ${p.id === activeId ? '<i data-lucide="check" class="w-4 h-4 text-blue-600"></i>' : ''}
                </button>
            `).join('');

            container.innerHTML = `
                <div class="p-3 border-b border-slate-100 sticky top-0 bg-white z-10">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                         <input type="text" placeholder="Tìm bệnh nhân..." 
                            oninput="renderPatientSwitcher(this.value)"
                            class="w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-blue-100"
                            value="${filterText}" autofocus>
                    </div>
                </div>
                <div class="max-h-60 overflow-y-auto">
                    ${listHtml.length > 0 ? listHtml : '<p class="text-xs text-slate-400 text-center py-4">Không tìm thấy</p>'}
                </div>
                <div class="p-2 border-t border-slate-100 sticky bottom-0 bg-white z-10">
                    <button onclick="document.getElementById('patient-switcher-dropdown').classList.add('hidden'); openCreatePatientModal();" 
                        class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-xl text-xs font-bold hover:bg-blue-700 transition-all">
                        <i data-lucide="plus" class="w-4 h-4"></i> Thêm bệnh nhân
                    </button>
                </div>
            `;

            // Focus input if filterText is present (to keep focus during re-render)
            if (filterText) {
                const input = container.querySelector('input');
                if (input) {
                    input.selectionStart = input.selectionEnd = input.value.length;
                    setTimeout(() => input.focus(), 0);
                }
            }

            lucide.createIcons();
        }

        function updatePatientDetailProfile() {
            const patientId = getCurrentPatientId();
            const patient = getPatientById(patientId);

            if (patient) {
                // Update avatar
                document.getElementById('patient-avatar').textContent = patient.fullName.charAt(0).toUpperCase();

                // Update name
                document.getElementById('patient-detail-name').textContent = patient.fullName;

                // Update care level
                document.getElementById('patient-detail-care-level').textContent = patient.careLevel || '---';

                // Update ID
                document.getElementById('patient-detail-id').textContent = 'ID: ' + patient.id;

                // Calculate age and format gender
                let ageGenderText = '--- • ---';
                if (patient.dateOfBirth) {
                    const birthDate = new Date(patient.dateOfBirth);
                    const age = new Date().getFullYear() - birthDate.getFullYear();
                    const genderText = patient.gender === 'male' ? 'Nam' : (patient.gender === 'female' ? 'Nữ' : '---');
                    ageGenderText = `${age} tuổi • ${genderText}`;
                }
                document.getElementById('patient-detail-age-gender').textContent = ageGenderText;
            } else {
                document.getElementById('patient-avatar').textContent = '?';
                document.getElementById('patient-detail-name').textContent = 'Chưa chọn bệnh nhân';
                document.getElementById('patient-detail-care-level').textContent = '---';
                document.getElementById('patient-detail-id').textContent = 'ID: ---';
                document.getElementById('patient-detail-age-gender').textContent = '--- • ---';
            }
        }

        function loadPatientList() {
            const patients = getAllPatients();
            const activePatientId = getCurrentPatientId();
            const listContainer = document.getElementById('patient-list');

            if (patients.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-4">Chưa có bệnh nhân nào</p>';
                return;
            }

            listContainer.innerHTML = patients.map(patient => {
                const isActive = patient.id === activePatientId;
                return `
                    <button onclick="switchToPatient('${patient.id}')" 
                        class="w-full p-3 rounded-xl hover:bg-slate-50 transition-all text-left ${isActive ? 'bg-blue-50 border-2 border-blue-200' : 'border-2 border-transparent'}">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center text-blue-600 font-black">
                                ${patient.fullName.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-slate-800">${patient.fullName}</p>
                                <p class="text-xs text-slate-400">${patient.id}</p>
                            </div>
                            ${isActive ? '<i data-lucide="check" class="w-4 h-4 text-blue-600"></i>' : ''}
                        </div>
                    </button>
                `;
            }).join('');

            lucide.createIcons();
        }

        // function togglePatientSwitcher() { ... } // Removed

        function switchToPatient(patientId) {
            setCurrentPatientId(patientId);

            // Update UI
            updateActivePatientDisplay();
            renderModuleTabs();

            // Reload current module to show data for new patient
            if (currentModuleId) {
                renderModuleView(currentModuleId);
            }

            // Show Toast removed to reduce noise or keep it
            // showToast('Đã chuyển sang bệnh nhân: ' + getPatientById(patientId).fullName, 'success');
        }

        function openCreatePatientModal() {
            document.getElementById('create-patient-modal').classList.remove('hidden');
        }

        function closeCreatePatientModal() {
            document.getElementById('create-patient-modal').classList.add('hidden');
            document.getElementById('create-patient-form').reset();
        }

        // --- User Profile Functions ---
        function toggleUserProfile() {
            const dropdown = document.getElementById('user-profile-dropdown');
            dropdown.classList.toggle('hidden');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (e) {
            // User Profile Dropdown
            const userBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-profile-dropdown');

            if (userBtn && userDropdown && !userBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                userDropdown.classList.add('hidden');
            }
        });



        // Handle patient creation form
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('create-patient-form').addEventListener('submit', function (e) {
                e.preventDefault();

                const patientData = {
                    fullName: document.getElementById('new-patient-name').value,
                    dateOfBirth: document.getElementById('new-patient-dob').value,
                    gender: document.getElementById('new-patient-gender').value,
                    careLevel: document.getElementById('new-patient-care-level').value
                };

                const newPatient = createPatient(patientData);

                closeCreatePatientModal();
                updateActivePatientDisplay();
                renderDashboard(); // Refresh dashboard table
                showToast('Đã tạo bệnh nhân: ' + newPatient.fullName, 'success');

                // Switch to patient detail view
                switchTab('patients');
                setActiveModule(1);
            });
        });

        // --- Scroll Helper Functions ---

        window.scrollToModule = (direction) => {
            // Target all potential scrollable containers
            const containers = [
                document.getElementById('module-content'),
                document.getElementById('content-area'),
                window
            ];

            containers.forEach(container => {
                if (!container) return;

                try {
                    if (direction === 'top') {
                        container.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        // For window/document, scrollHeight is on body/documentElement
                        let scrollHeight;
                        if (container === window) {
                            scrollHeight = Math.max(
                                document.body.scrollHeight,
                                document.documentElement.scrollHeight,
                                document.body.offsetHeight,
                                document.documentElement.offsetHeight,
                                document.body.clientHeight,
                                document.documentElement.clientHeight
                            );
                        } else {
                            scrollHeight = container.scrollHeight;
                        }

                        container.scrollTo({ top: scrollHeight, behavior: 'smooth' });
                    }
                } catch (e) {
                    // Fallback for older browsers or window object strictness
                    if (direction === 'top') {
                        container.scrollTop = 0;
                    } else {
                        if (container.scrollHeight) container.scrollTop = container.scrollHeight;
                    }
                }
            });
        };

        function initScrollButtons() {
            // Check if already exists
            if (document.getElementById('scroll-buttons-container')) return;

            // Create Container
            const container = document.createElement('div');
            container.id = 'scroll-buttons-container';
            container.className = 'fixed bottom-8 right-8 flex flex-col gap-2 z-50 transition-opacity duration-300 hidden'; // Default hidden
            container.innerHTML = `
                <button id="btn-scroll-top" class="p-3 bg-white/80 backdrop-blur text-slate-600 rounded-full shadow-lg hover:bg-white hover:text-blue-600 hover:scale-110 active:scale-90 transition-all border border-slate-100 ring-1 ring-slate-900/5 group" title="Lên đầu trang">
                    <i data-lucide="arrow-up" class="w-5 h-5"></i>
                </button>
                <button id="btn-scroll-bottom" class="p-3 bg-white/80 backdrop-blur text-slate-600 rounded-full shadow-lg hover:bg-white hover:text-blue-600 hover:scale-110 active:scale-90 transition-all border border-slate-100 ring-1 ring-slate-900/5 group" title="Xuống cuối trang">
                    <i data-lucide="arrow-down" class="w-5 h-5"></i>
                </button>
            `;
            document.body.appendChild(container); // Append to body

            // Re-init icons for new buttons
            lucide.createIcons();

            // Attach event listeners explicitly (more robust than onclick string)
            document.getElementById('btn-scroll-top').addEventListener('click', () => window.scrollToModule('top'));
            document.getElementById('btn-scroll-bottom').addEventListener('click', () => window.scrollToModule('bottom'));

            // Visibility Check Function
            const checkVisibility = () => {
                const businessSection = document.getElementById('section-business');
                const scrollBtns = document.getElementById('scroll-buttons-container');

                if (businessSection && !businessSection.classList.contains('hidden-section')) {
                    scrollBtns.classList.remove('hidden');
                } else {
                    scrollBtns.classList.add('hidden');
                }
            };

            // Observer
            const observer = new MutationObserver(checkVisibility);
            const businessSection = document.getElementById('section-business');
            if (businessSection) {
                observer.observe(businessSection, { attributes: true, attributeFilter: ['class'] });
            }

            // Initial Check
            checkVisibility();
        }

        function toggleAuthMode(mode) {
            const loginContainer = document.getElementById('login-form-container');
            const regContainer = document.getElementById('register-form-container');

            if (mode === 'register') {
                loginContainer.classList.add('hidden');
                regContainer.classList.remove('hidden');
                regContainer.classList.add('animate-fade-in');
            } else {
                regContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                loginContainer.classList.add('animate-fade-in');
            }
        }

        // --- Settings Functions ---
        function openSettingsModal() {
            document.getElementById('settings-modal').classList.remove('hidden');
            // Hide other dropdowns
            document.getElementById('user-profile-dropdown').classList.add('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
            document.getElementById('change-password-form').reset();
        }

        function confirmResetData() {
            if (confirm('⚠️ KHÔI PHỤC DỮ LIỆU?\n\nHành động này không thể hoàn tác.\nTất cả dữ liệu bệnh nhân sẽ bị xóa.\nTài khoản sẽ đăng xuất.')) {
                resetDemoData();
            }
        }

        // Settings Listeners
        document.getElementById('change-password-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const oldPass = document.getElementById('set-old-pass').value;
            const newPass = document.getElementById('set-new-pass').value;
            const session = JSON.parse(localStorage.getItem('mirabocaresync_session'));

            try {
                if (changePassword(session.user.username, oldPass, newPass)) {
                    showToast('Đổi mật khẩu thành công!', 'success');
                    closeSettingsModal();
                }
            } catch (e) {
                showToast(e.message, 'error');
            }
        });

        // --- User Profile Functions ---
        function openUserProfileModal() {
            const session = JSON.parse(localStorage.getItem('mirabocaresync_session'));
            if (!session) return;

            const profile = getUserProfile(session.user.username);
            if (!profile) return; // Should not happen

            // Populate Form
            document.getElementById('up-fullname').value = profile.fullName || '';
            document.getElementById('up-identifier').value = profile.identifier || ''; // Staff ID
            document.getElementById('up-dob').value = profile.birthDate || '';
            document.getElementById('up-gender').value = profile.gender || '';
            document.getElementById('up-phone').value = profile.telecomPhone || '';
            document.getElementById('up-email').value = profile.telecomEmail || '';
            document.getElementById('up-address').value = profile.address || '';
            document.getElementById('up-role').value = profile.roleTitle || '';
            document.getElementById('up-qualification').value = profile.qualificationCode || '';

            document.getElementById('user-profile-modal').classList.remove('hidden');
            document.getElementById('user-profile-dropdown').classList.add('hidden'); // Close dropdown
        }

        function closeUserProfileModal() {
            document.getElementById('user-profile-modal').classList.add('hidden');
        }

        document.getElementById('user-profile-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const session = JSON.parse(localStorage.getItem('mirabocaresync_session'));
            if (!session) return;

            const updateData = {
                fullName: document.getElementById('up-fullname').value,
                identifier: document.getElementById('up-identifier').value,
                birthDate: document.getElementById('up-dob').value,
                gender: document.getElementById('up-gender').value,
                telecomPhone: document.getElementById('up-phone').value,
                telecomEmail: document.getElementById('up-email').value,
                address: document.getElementById('up-address').value,
                roleTitle: document.getElementById('up-role').value,
                qualificationCode: document.getElementById('up-qualification').value
            };

            try {
                updateUserProfile(session.user.username, updateData);
                checkLogin(); // Refresh header UI
                showToast('Đã lưu hồ sơ nhân viên', 'success');
                closeUserProfileModal();
            } catch (e) {
                showToast('Lỗi khi lưu hồ sơ: ' + e.message, 'error');
            }
        });

        // --- Core ---
        window.onload = () => {
            lucide.createIcons();
            renderModuleTabs();
            renderPatientList();
            updateActivePatientDisplay();

            // Wait for DOM layout to stabilize before initializing scroll
            setTimeout(() => {
                initScrollButtons(); // Initialize helper
            }, 100);

            checkLogin(); // Check authentication

            // Pre-fill Remembered Username
            const rememberedUser = localStorage.getItem('mirabocaresync_remembered_username');
            if (rememberedUser) {
                document.getElementById('login-username').value = rememberedUser;
                document.getElementById('login-remember').checked = true;
                // Optional: Focus password field if username is filled
                document.getElementById('login-password').focus();
            }

            // Auth Form Listeners
            document.getElementById('login-form').addEventListener('submit', function (e) {
                e.preventDefault();
                const u = document.getElementById('login-username').value;
                const p = document.getElementById('login-password').value;
                const r = document.getElementById('login-remember').checked;
                try {
                    if (login(u, p, r)) {
                        checkLogin(); // update UI
                        showToast('Đăng nhập thành công!', 'success');
                    }
                } catch (err) {
                    showToast(err.message, 'error');
                }
            });

            document.getElementById('register-form').addEventListener('submit', function (e) {
                e.preventDefault();
                const fn = document.getElementById('reg-fullname').value;
                const u = document.getElementById('reg-username').value;
                const p = document.getElementById('reg-password').value;
                const cp = document.getElementById('reg-confirm-password').value;

                if (p !== cp) {
                    showToast('Mật khẩu không khớp!', 'error');
                    return;
                }

                try {
                    const user = register(fn, u, p);
                    showToast('Đăng ký thành công! Vui lòng đăng nhập.', 'success');
                    toggleAuthMode('login');
                    document.getElementById('login-username').value = u;
                    document.getElementById('login-password').focus();
                } catch (err) {
                    showToast(err.message, 'error');
                }
            });
        };

        // --- Mockup Helper: Clear All Data ---
        document.addEventListener('keydown', function (e) {
            // Ctrl+Shift+Delete (or Cmd+Shift+Delete on Mac)
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Delete') {
                e.preventDefault();

                if (confirm('⚠️ MOCKUP MODE: Xóa tất cả dữ liệu?\n\nĐiều này sẽ xóa:\n- Tất cả bệnh nhân\n- Tất cả dữ liệu module\n- Reset về trạng thái ban đầu\n\nBạn có chắc chắn?')) {
                    // Clear all localStorage data
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('mirabocaresync_')) {
                            keysToRemove.push(key);
                        }
                    }

                    keysToRemove.forEach(key => localStorage.removeItem(key));

                    showToast('✅ Đã xóa tất cả dữ liệu mockup!', 'success');

                    // Reload page to reset UI
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            }
        });

        function switchTab(tab) {
            document.getElementById('section-patients').classList.toggle('hidden-section', tab !== 'patients');
            document.getElementById('section-business').classList.toggle('hidden-section', tab !== 'business');

            const btnP = document.getElementById('btn-patients');
            const btnB = document.getElementById('btn-business');

            if (tab === 'patients') {
                btnP.classList.add('bg-[#007AFF]/10', 'text-[#007AFF]');
                btnP.classList.remove('text-slate-700', 'hover:bg-slate-200/50');

                btnB.classList.remove('bg-[#007AFF]/10', 'text-[#007AFF]');
                btnB.classList.add('text-slate-700', 'hover:bg-slate-200/50');

                renderPatientList();
            } else if (tab === 'business') {
                btnB.classList.add('bg-[#007AFF]/10', 'text-[#007AFF]');
                btnB.classList.remove('text-slate-700', 'hover:bg-slate-200/50');

                btnP.classList.remove('bg-[#007AFF]/10', 'text-[#007AFF]');
                btnP.classList.add('text-slate-700', 'hover:bg-slate-200/50');
            }
        }

        function openPatient(id) {
            // Set the patient as active
            setCurrentPatientId(id);
            updateActivePatientDisplay();
            renderModuleTabs(); // Ensure checkmarks update

            switchTab('business');
            setActiveModule(1);
        }

        let currentFilter = 'all'; // Track current filter
        let currentSearchQuery = ''; // Track search query

        function searchPatients(query) {
            currentSearchQuery = query.toLowerCase();
            renderPatientList();
        }

        function renderPatientList(filter = currentFilter) {
            currentFilter = filter;

            // Update Segmented Control Styles
            const activeClass = 'flex-1 py-1.5 rounded-md text-[13px] font-semibold text-center transition-all shadow-sm bg-white text-slate-900';
            const inactiveClass = 'flex-1 py-1.5 rounded-md text-[13px] font-medium text-center text-slate-500 hover:text-slate-900 transition-all';

            document.getElementById('filter-all').className = filter === 'all' ? activeClass : inactiveClass;
            document.getElementById('filter-active').className = filter === 'active' ? activeClass : inactiveClass;
            document.getElementById('filter-inactive').className = filter === 'inactive' ? activeClass : inactiveClass;

            // Populate patient table & Mobile List
            let patients = getAllPatients();

            // Apply filter
            if (filter === 'active') {
                patients = patients.filter(p => p.active !== false);
            } else if (filter === 'inactive') {
                patients = patients.filter(p => p.active === false);
            }

            // Apply Search
            if (currentSearchQuery) {
                patients = patients.filter(p =>
                    p.fullName.toLowerCase().includes(currentSearchQuery) ||
                    p.id.toLowerCase().includes(currentSearchQuery)
                );
            }

            const tbody = document.querySelector('#section-patients tbody');

            if (!tbody) return;

            if (patients.length === 0) {
                const message = filter === 'all'
                    ? 'Chưa có bệnh nhân nào. Tap "Thêm mới" để bắt đầu.'
                    : filter === 'active'
                        ? 'Không có bệnh nhân đang hoạt động.'
                        : 'Không có bệnh nhân đã vô hiệu.';

                // Desktop Empty
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 md:px-10 py-12 text-center text-slate-400">
                            <p class="text-sm font-medium">${message}</p>
                        </td>
                    </tr>
                `;

                // Mobile Empty
                const mobileList = document.getElementById('mobile-patient-list');
                if (mobileList) {
                    mobileList.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                             <i data-lucide="users" class="w-12 h-12 mb-4 text-slate-300"></i>
                             <p class="text-sm font-medium text-center px-6">${message}</p>
                        </div>
                    `;
                }
                lucide.createIcons();
                return;
            }

            // Generate HTML for both Mobile and Desktop
            let desktopRows = '';
            let mobileItems = '';

            patients.forEach(patient => {
                const initial = patient.fullName.charAt(0).toUpperCase();
                const isActive = patient.active !== false;

                // Status Labels
                let statusLabel = isActive ? 'Hoạt động' : 'Vô hiệu';
                let statusColorClass = isActive ? 'text-emerald-600' : 'text-slate-400';

                // --- Desktop Row Construction ---
                let statusBadge = '';
                if (isActive) {
                    statusBadge = '<span class="px-3 py-1 bg-emerald-50 text-emerald-600 rounded-lg text-xs font-semibold">Đang hoạt động</span>';
                } else if (patient.status === 'deceased') {
                    statusBadge = '<span class="px-3 py-1 bg-red-50 text-red-600 rounded-lg text-xs font-semibold">Đã mất</span>';
                } else {
                    statusBadge = '<span class="px-3 py-1 bg-slate-100 text-slate-500 rounded-lg text-xs font-semibold">Đã vô hiệu</span>';
                }

                // Action buttons (Desktop) calls existing logic
                // Simplified for brevity in this tool call, assuming reusing similar logic or string building
                let actionButton = `<button onclick="openPatient('${patient.id}')" class="text-blue-600 font-semibold text-sm hover:underline">Xem hồ sơ</button>`; // Simplified desktop action

                // Calculate Progress
                const status = JSON.parse(localStorage.getItem(`mirabocaresync_${patient.id}_status`) || '{}');
                const validModules = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                const realCount = validModules.filter(id => status[`module${id}`]).length;
                const totalModules = 9;
                const progressPercent = Math.round((realCount / totalModules) * 100);

                desktopRows += `
                    <tr class="hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0 cursor-pointer" onclick="openPatient('${patient.id}')">
                        <td class="px-4 md:px-6 lg:px-10 py-4 text-slate-900 flex items-center gap-4 whitespace-nowrap">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-semibold text-sm">
                                ${initial}
                            </div>
                            <div>
                                <div class="font-semibold text-sm">${patient.fullName}</div>
                                <div class="text-xs text-slate-400 mt-0.5">ID: ${patient.id}</div>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 lg:px-10 py-4 text-slate-500 text-sm whitespace-nowrap">${patient.careLevel || 'Chăm sóc 1'}</td>
                        <td class="px-4 md:px-6 lg:px-10 py-4 text-slate-500 text-sm whitespace-nowrap">
                            <div class="flex items-center gap-2">
                                <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500 rounded-full" style="width: ${progressPercent}%"></div>
                                </div>
                                <span class="text-xs font-medium text-slate-600">${realCount}/${totalModules}</span>
                            </div>
                        </td>
                        <td class="px-4 md:px-6 lg:px-10 py-4 whitespace-nowrap">
                            ${statusBadge}
                        </td>
                        <td class="px-4 md:px-6 lg:px-10 py-4 text-right whitespace-nowrap">
                            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300 inline-block"></i>
                        </td>
                    </tr>
                `;

                // --- Mobile Item Construction (iOS Style) ---
                mobileItems += `
                    <div onclick="openPatient('${patient.id}')" class="group bg-white rounded-[10px] p-4 flex items-center gap-4 shadow-[0_1px_2px_rgba(0,0,0,0.05)] active:scale-[0.98] transition-transform">
                        <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-[#8E8E93] text-[17px] font-semibold shrink-0">
                             ${initial}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h4 class="font-semibold text-[17px] text-[#000000] truncate leading-tight">${patient.fullName}</h4>
                                <span class="text-[13px] ${statusColorClass} font-normal shrink-0">${statusLabel}</span>
                            </div>
                            <p class="text-[15px] text-[#8E8E93] truncate mt-0.5">${patient.careLevel || 'Chăm sóc 1'}</p>
                            <div class="mt-2 text-[10px] text-[#8E8E93] font-medium bg-[#F2F2F7] inline-block px-2 py-0.5 rounded-md uppercase tracking-wider">
                                Hoàn thành ${realCount}/${totalModules}
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-[#C7C7CC] shrink-0"></i>
                    </div>
                `;
            });

            // Update DOM
            tbody.innerHTML = desktopRows;
            const mobileList = document.getElementById('mobile-patient-list');
            if (mobileList) {
                // Remove the wrapper div here, since we are doing individual cards for "Inset Grouped" feel
                mobileList.innerHTML = mobileItems;
            }

            lucide.createIcons();
        }

        function filterPatients(status) {
            renderPatientList(status);
        }

        function openDeactivateModal(patientId) {
            document.getElementById('deactivate-patient-id').value = patientId;
            document.getElementById('deactivate-patient-modal').classList.remove('hidden');
        }

        function closeDeactivateModal() {
            document.getElementById('deactivate-patient-modal').classList.add('hidden');
            document.getElementById('deactivate-patient-form').reset();
        }

        function confirmReactivate(patientId) {
            const patient = getPatientById(patientId);
            if (!patient) return;

            if (confirm(`Kích hoạt lại bệnh nhân "${patient.fullName}" ?\n\nBệnh nhân sẽ được đánh dấu là đang hoạt động.`)) {
                if (reactivatePatient(patientId)) {
                    showToast(`Đã kích hoạt lại bệnh nhân: ${patient.fullName} `, 'success');
                    renderPatientList();
                }
            }
        }

        // Handle deactivation form submission
        document.addEventListener('DOMContentLoaded', function () {
            // Click outside to close Patient Switcher
            document.addEventListener('click', function (event) {
                const switcher = document.getElementById('patient-switcher-dropdown');
                const toggleBtn = event.target.closest('button[onclick*="patient-switcher-dropdown"]');
                const isInsideSwitcher = event.target.closest('#patient-switcher-dropdown');

                if (switcher && !switcher.classList.contains('hidden') && !toggleBtn && !isInsideSwitcher) {
                    switcher.classList.add('hidden');
                }
            });

            // Listen for module data save events to refresh progress
            window.addEventListener('module-data-saved', function () {
                renderModuleTabs();
            });

            document.getElementById('deactivate-patient-form')?.addEventListener('submit', function (e) {
                e.preventDefault();

                const patientId = document.getElementById('deactivate-patient-id').value;
                const reason = document.getElementById('deactivation-reason').value;
                const notes = document.getElementById('deactivation-notes').value;

                const patient = getPatientById(patientId);
                if (!patient) return;

                if (deactivatePatient(patientId, reason, notes)) {
                    showToast(`Đã vô hiệu hóa bệnh nhân: ${patient.fullName} `, 'success');
                    closeDeactivateModal();
                    renderPatientList();
                }
            });
        });

        function renderModuleTabs() {
            const container = document.getElementById('module-tabs');
            const patientId = getCurrentPatientId();
            const status = JSON.parse(localStorage.getItem(`mirabocaresync_${patientId}_status`) || '{}');

            container.innerHTML = modules.map(m => {
                const isComplete = status[`module${m.id}`];
                const isActive = m.id === currentModuleId;

                const activeClasses = 'active-module border-blue-400 ring-[6px] ring-blue-50';
                const inactiveClasses = 'border-slate-100 hover:border-blue-300';

                const iconActiveClasses = 'bg-blue-600 text-white';
                const iconInactiveClasses = 'bg-slate-100 text-slate-500';

                return `
                <button onclick="setActiveModule(${m.id})" id="module-btn-${m.id}" 
                    class="w-full flex items-center justify-between p-5 rounded-3xl border transition-all text-left bg-white group shadow-sm relative overflow-hidden ${isActive ? activeClasses : inactiveClasses}">
                    <div class="flex items-center gap-5 z-10">
                        <div class="module-icon-box p-3 rounded-2xl transition-all ${isActive ? iconActiveClasses : iconInactiveClasses}">
                            <i data-lucide="${m.icon}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="text-[9px] font-black uppercase text-slate-400 tracking-widest mb-0.5">Nghiệp vụ ${m.code || '0' + m.id}</p>
                            <p class="text-sm font-bold text-slate-700">${m.title.split(' (')[0]}</p>
                        </div>
                    </div>
                    ${isComplete ? `
                    <div class="bg-emerald-100 p-1.5 rounded-full mr-2 z-10">
                        <i data-lucide="check" class="w-4 h-4 text-emerald-600 font-bold"></i>
                    </div>
                    ` : ''}
                </button>
            `}).join('');
            lucide.createIcons();
        }

        // --- Mobile View Logic ---
        let currentMobileState = 'dashboard';

        function checkMobileView() {
            return window.innerWidth < 1024; // lg breakpoint matches CSS
        }

        function toggleMobileView(view) {
            const dashboard = document.getElementById('mobile-dashboard-view');
            const detail = document.getElementById('mobile-detail-view');

            if (!checkMobileView()) {
                // Desktop: Ensure both visible
                if (dashboard) dashboard.classList.remove('hidden');
                if (detail) detail.classList.remove('hidden');
                return;
            }

            if (view === 'dashboard') {
                if (dashboard) dashboard.classList.remove('hidden');
                if (detail) detail.classList.add('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                if (dashboard) dashboard.classList.add('hidden');
                if (detail) detail.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            currentMobileState = view;
        }

        // Resize Listener
        window.addEventListener('resize', () => {
            if (!checkMobileView()) {
                const dashboard = document.getElementById('mobile-dashboard-view');
                const detail = document.getElementById('mobile-detail-view');
                if (dashboard) dashboard.classList.remove('hidden');
                if (detail) detail.classList.remove('hidden');
            } else {
                toggleMobileView(currentMobileState);
            }
        });

        function setActiveModule(id) {
            currentModuleId = id;

            // Switch to detail view on mobile
            if (checkMobileView()) {
                toggleMobileView('detail');
            }

            modules.forEach(m => {
                const btn = document.getElementById(`module-btn-${m.id}`);
                const iconBox = btn.querySelector('.module-icon-box');
                if (m.id === id) {
                    btn.classList.add('active-module', 'border-blue-400', 'ring-[6px]', 'ring-blue-50');
                    iconBox.classList.add('bg-blue-600', 'text-white');
                    iconBox.classList.remove('bg-slate-100', 'text-slate-500');
                } else {
                    btn.classList.remove('active-module', 'border-blue-400', 'ring-[6px]', 'ring-blue-50');
                    iconBox.classList.remove('bg-blue-600', 'text-white');
                    iconBox.classList.add('bg-slate-100', 'text-slate-500');
                }
            });

            renderModuleView(id);
        }

        function renderModuleView(id) {
            const content = document.getElementById('module-content');

            // Check for modern render function first (e.g., renderModule7(content))
            const renderFuncName = 'renderModule' + id;
            console.log(`[Loader] Attempting to render module ${id}`);
            console.log(`[Loader] Checking for function: ${renderFuncName}`, typeof window[renderFuncName]);

            if (typeof window[renderFuncName] === 'function') {
                console.log(`[Loader] Function ${renderFuncName} found. Executing...`);
                content.innerHTML = ''; // Clear previous content
                // Clear header actions
                const actionsContainer = document.getElementById('module-actions');
                if (actionsContainer) actionsContainer.innerHTML = '';

                try {
                    window[renderFuncName](content);
                    console.log(`[Loader] ${renderFuncName} executed successfully.`);
                } catch (e) {
                    console.error(`[Loader] Error executing ${renderFuncName}:`, e);
                    content.innerHTML = `<div class="p-4 text-red-500">Lỗi tải module: ${e.message}</div>`;
                }
                return;
            } else {
                console.warn(`[Loader] Function ${renderFuncName} NOT found directly on window.`);
            }

            // Fallback to legacy string content variable (e.g., module1Content)
            const contentVarName = 'module' + id + 'Content';

            if (window[contentVarName]) {
                content.innerHTML = window[contentVarName];

                // Initialize module logic if init function exists
                const initFuncName = 'initModule' + id;
                if (typeof window[initFuncName] === 'function') {
                    // Slight delay to ensure DOM is ready
                    setTimeout(() => window[initFuncName](), 0);
                }
            } else {
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-[400px] bg-slate-50 rounded-[48px] border-4 border-dashed border-slate-100">
                        <i data-lucide="package" class="w-16 h-16 text-slate-200 mb-6"></i>
                        <p class="font-black text-slate-400 uppercase tracking-[4px] text-xs">Module đang cập nhật dữ liệu</p>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function renderDashboard() {
            // Placeholder for dashboard logic if needed
        }

        // --- Mobile Sidebar Function ---
        function toggleSidebar() {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            if (sidebar.classList.contains('-translate-x-full')) {
                // Open
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                // Close
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function toggleDesktopSidebar() {
            const sidebar = document.getElementById('main-sidebar');
            const icon = document.getElementById('sidebar-toggle-icon');

            sidebar.classList.toggle('is-expanded');

            // Toggle Width Classes
            sidebar.classList.toggle('lg:w-20');
            sidebar.classList.toggle('lg:w-80');

            // Toggle Icon Rotation
            if (sidebar.classList.contains('is-expanded')) {
                icon.classList.add('rotate-180');
            } else {
                icon.classList.remove('rotate-180');
            }
        }
    </script>

    <!-- FAB Helper Module -->
    <script src="fabHelper.js"></script>
    <script src="module1.js"></script>
    <script src="module2.js"></script>
    <script src="module3.js"></script>
    <script src="module4.js"></script>
    <script src="module5.js"></script>
    <script src="module6.js"></script>
    <script src="module7.js"></script>
    <script src="module8.js"></script>
    <script src="module9.js"></script>

    <!-- PDF Preview Modal -->
    <div id="pdf-preview-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[9999] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full h-full max-w-6xl flex flex-col overflow-hidden shadow-2xl">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-slate-800">Xem trước báo cáo PDF</h3>
                        <p class="text-sm text-slate-500" id="pdf-preview-filename">Report.pdf</p>
                    </div>
                </div>
                <button onclick="closePdfPreview()"
                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- PDF Viewer Iframe -->
            <div class="flex-1 bg-slate-100 relative">
                <div id="pdf-loading"
                    class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 gap-3">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-indigo-600"></i>
                    <p class="font-medium">Đang tạo PDF chuẩn y khoa...</p>
                </div>
                <iframe id="pdf-viewer-frame" class="w-full h-full border-0 hidden"></iframe>
            </div>
        </div>
    </div>

    <!-- Module 10 PDF Generator (Professional Medical Report) -->
    <script src="module10_pdf.js"></script>
</body>

</html>