<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Daycare - Bản Mockup</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .active-module {
            border-color: #2563eb;
            background-color: #f8fafc;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .sidebar-item-active {
            background-color: #2563eb;
            color: white;
        }

        .hidden-section {
            display: none;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        /* Animation cho mượt */
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-[#f8fafc] text-slate-900 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-72 bg-slate-900 flex-col text-white hidden lg:flex shadow-2xl z-20">
        <div class="p-8 border-b border-slate-800 flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-500/20"><i data-lucide="activity"
                    class="text-white"></i></div>
            <span class="font-extrabold text-xl tracking-tight">DAYCARE <span class="text-blue-500">PRO</span></span>
        </div>

        <nav class="flex-1 p-6 space-y-3 overflow-y-auto">
            <p class="text-[10px] font-black text-slate-500 uppercase tracking-[2px] mb-2 px-4">Quản lý</p>
            <button onclick="switchTab('patients')" id="btn-patients"
                class="sidebar-item-active w-full flex items-center gap-3 px-5 py-4 rounded-2xl transition-all font-bold text-sm">
                <i data-lucide="users" class="w-5 h-5"></i> Danh sách bệnh nhân
            </button>
            <button onclick="switchTab('business')" id="btn-business"
                class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl transition-all text-slate-400 hover:bg-slate-800 hover:text-white font-bold text-sm">
                <i data-lucide="clipboard-list" class="w-5 h-5"></i> Nghiệp vụ
            </button>

            <p class="text-[10px] font-black text-slate-500 uppercase tracking-[2px] mt-8 mb-2 px-4">Hệ thống</p>
            <button
                class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl text-slate-400 hover:bg-slate-800 font-bold text-sm">
                <i data-lucide="settings" class="w-5 h-5"></i> Cài đặt
            </button>
        </nav>

        <div class="p-6 border-t border-slate-800">
            <button
                class="w-full flex items-center gap-3 px-5 py-4 rounded-2xl text-rose-400 hover:bg-rose-900/20 font-bold text-sm transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i> Đăng xuất
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        <!-- Header -->
        <header class="h-20 bg-white border-b flex items-center justify-between px-10 z-10 shadow-sm">
            <div>
                <h2 id="header-title" class="text-xl font-black text-slate-800 tracking-tight">Danh sách bệnh nhân</h2>
                <p id="header-subtitle" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Trung tâm
                    Daycare Phục hồi chức năng</p>
            </div>

            <div class="flex items-center gap-4">
                <!-- Patient Switcher -->
                <div class="relative">
                    <button id="patient-switcher-btn" onclick="togglePatientSwitcher()"
                        class="flex items-center gap-3 px-4 py-2 bg-slate-50 hover:bg-slate-100 rounded-2xl border border-slate-200 transition-all">
                        <div
                            class="w-8 h-8 rounded-xl bg-blue-100 flex items-center justify-center text-blue-600 text-sm font-black">
                            <span id="patient-initial">?</span>
                        </div>
                        <div class="text-left">
                            <p id="active-patient-name" class="text-xs font-bold text-slate-800">Chưa chọn</p>
                            <p id="active-patient-id" class="text-[9px] text-slate-400 font-semibold">---</p>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                    </button>

                    <!-- Dropdown -->
                    <div id="patient-switcher-dropdown"
                        class="hidden absolute right-0 mt-2 w-72 bg-white rounded-2xl shadow-2xl border border-slate-200 z-50 max-h-96 overflow-y-auto">
                        <div class="p-4 border-b border-slate-100">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Danh sách bệnh nhân
                            </p>
                        </div>
                        <div id="patient-list" class="p-2">
                            <!-- Patient items will be inserted here -->
                        </div>
                        <div class="p-2 border-t border-slate-100">
                            <button onclick="openCreatePatientModal()"
                                class="w-full px-4 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Tạo bệnh nhân mới
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-10">

            <!-- Patient List Section -->
            <section id="section-patients" class="max-w-7xl mx-auto space-y-10 animate-fade-in">

                <div class="bg-white rounded-[40px] border border-slate-100 shadow-sm overflow-hidden">
                    <div class="p-8 border-b flex justify-between items-center bg-slate-50/30">
                        <div>
                            <h3 class="font-black text-slate-800 text-lg tracking-tight">Danh sách bệnh nhân</h3>
                            <!-- Status Filter Buttons -->
                            <div class="flex gap-2 mt-3">
                                <button onclick="filterPatients('all')" id="filter-all"
                                    class="px-4 py-2 rounded-xl text-xs font-bold bg-blue-600 text-white">
                                    Tất cả
                                </button>
                                <button onclick="filterPatients('active')" id="filter-active"
                                    class="px-4 py-2 rounded-xl text-xs font-bold bg-slate-100 text-slate-600 hover:bg-slate-200">
                                    Đang hoạt động
                                </button>
                                <button onclick="filterPatients('inactive')" id="filter-inactive"
                                    class="px-4 py-2 rounded-xl text-xs font-bold bg-slate-100 text-slate-600 hover:bg-slate-200">
                                    Đã vô hiệu
                                </button>
                            </div>
                        </div>
                        <button onclick="openCreatePatientModal()"
                            class="px-6 py-3 bg-blue-600 text-white rounded-2xl font-black text-sm hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Tạo bệnh nhân mới
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-white text-slate-400 text-[10px] uppercase font-black tracking-widest">
                                <tr>
                                    <th class="px-10 py-6">Tên Bệnh nhân</th>
                                    <th class="px-10 py-6">Mức độ</th>
                                    <th class="px-10 py-6">Trạng thái</th>
                                    <th class="px-10 py-6 text-right">Hành động</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50 text-sm font-medium">
                                <tr class="hover:bg-slate-50/50 transition-all">
                                    <td class="px-10 py-6 text-slate-800 flex items-center gap-4">
                                        <div
                                            class="w-10 h-10 rounded-2xl bg-blue-100 flex items-center justify-center text-blue-600 font-black">
                                            A</div>
                                        Nguyễn Văn A
                                    </td>
                                    <td class="px-10 py-6 text-slate-600">Chăm sóc 2</td>
                                    <td class="px-10 py-6"><span
                                            class="px-4 py-1.5 bg-emerald-100 text-emerald-700 rounded-full text-[10px] font-black uppercase tracking-wider">Đang
                                            hoạt động</span></td>
                                    <td class="px-10 py-6 text-right">
                                        <button onclick="openPatient(1)"
                                            class="bg-slate-900 text-white px-6 py-2 rounded-2xl text-xs font-black hover:bg-blue-600 transition-all shadow-lg shadow-slate-200">Chi
                                            tiết hồ sơ</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Business Processes Section -->
            <section id="section-business" class="hidden-section max-w-7xl mx-auto space-y-8 animate-fade-in">
                <!-- Profile Card -->
                <div
                    class="bg-white p-8 rounded-[40px] border shadow-sm flex flex-col md:flex-row gap-8 items-center border-slate-100">
                    <div id="patient-avatar"
                        class="w-24 h-24 rounded-[32px] bg-gradient-to-br from-blue-600 to-indigo-700 flex items-center justify-center text-white text-4xl font-black">
                        ?
                    </div>
                    <div class="flex-1 text-center md:text-left">
                        <h1 id="patient-detail-name" class="text-3xl font-black text-slate-800 tracking-tight mb-2">Chưa
                            chọn bệnh nhân</h1>
                        <div
                            class="flex flex-wrap gap-4 text-[11px] font-bold text-slate-400 justify-center md:justify-start">
                            <span id="patient-detail-care-level"
                                class="bg-slate-100 px-3 py-1 rounded-lg text-slate-600 uppercase">---</span>
                            <span id="patient-detail-id">ID: ---</span>
                            <span id="patient-detail-age-gender">--- • ---</span>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="switchTab('patients')"
                            class="px-6 py-4 bg-slate-100 text-slate-600 rounded-3xl font-black text-sm hover:bg-slate-200 transition-all">
                            Quay lại danh sách</button>
                    </div>
                </div>

                <!-- 9 Modules Workspace -->
                <div class="flex flex-col lg:flex-row gap-10 pb-16">
                    <!-- Nav Tabs -->
                    <div id="module-tabs" class="w-full lg:w-80 space-y-3">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[3px] mb-6 pl-4">9 Nghiệp vụ
                            quản lý</p>
                        <!-- Module items via JS -->
                    </div>

                    <!-- Work Area -->
                    <div
                        class="flex-1 bg-white rounded-[48px] border border-slate-100 shadow-2xl overflow-hidden min-h-[600px] flex flex-col">
                        <div class="p-10 border-b bg-slate-50/40 flex justify-between items-center">
                            <div>
                                <h2 id="module-title" class="text-3xl font-black text-slate-800 tracking-tight italic">
                                    Face Sheet</h2>
                                <p class="text-[10px] text-blue-500 font-extrabold uppercase mt-2 tracking-[2px]">Tiêu
                                    chuẩn phục hồi chức năng Nhật Bản</p>
                            </div>
                        </div>
                        <div id="module-content" class="p-10 flex-1 overflow-y-auto min-h-[400px]">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Patient Creation Modal -->
    <div id="create-patient-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[40px] shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-8 border-b border-slate-100">
                <h2 class="text-2xl font-black text-slate-800">Tạo bệnh nhân mới</h2>
                <p class="text-sm text-slate-500 mt-1">Nhập thông tin cơ bản của bệnh nhân</p>
            </div>

            <form id="create-patient-form" class="p-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Họ và tên <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="new-patient-name" required
                            class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium"
                            placeholder="Nguyễn Văn A">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ngày sinh <span
                                class="text-red-500">*</span></label>
                        <input type="date" id="new-patient-dob" required
                            class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Giới tính <span
                                class="text-red-500">*</span></label>
                        <select id="new-patient-gender" required
                            class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium">
                            <option value="">Chọn giới tính</option>
                            <option value="male">Nam</option>
                            <option value="female">Nữ</option>
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Mức chăm sóc</label>
                        <select id="new-patient-care-level"
                            class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium">
                            <option value="Chăm sóc 1">Chăm sóc 1</option>
                            <option value="Chăm sóc 2">Chăm sóc 2</option>
                            <option value="Chăm sóc 3">Chăm sóc 3</option>
                            <option value="Chăm sóc 4">Chăm sóc 4</option>
                            <option value="Chăm sóc 5">Chăm sóc 5</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeCreatePatientModal()"
                        class="flex-1 px-6 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all">
                        Hủy
                    </button>
                    <button type="submit"
                        class="flex-1 px-6 py-4 bg-blue-600 text-white rounded-2xl font-black text-sm hover:bg-blue-700 shadow-xl shadow-blue-500/20 transition-all">
                        Tạo bệnh nhân
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Patient Deactivation Modal -->
    <div id="deactivate-patient-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[40px] shadow-2xl max-w-lg w-full">
            <div class="p-8 border-b border-slate-100">
                <h2 class="text-2xl font-black text-slate-800">Vô hiệu hóa bệnh nhân</h2>
                <p class="text-sm text-slate-500 mt-1">Bệnh nhân sẽ được đánh dấu là không hoạt động</p>
            </div>

            <form id="deactivate-patient-form" class="p-8 space-y-6">
                <input type="hidden" id="deactivate-patient-id">

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Lý do vô hiệu hóa <span
                            class="text-red-500">*</span></label>
                    <select id="deactivation-reason" required
                        class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium">
                        <option value="">Chọn lý do</option>
                        <option value="discharged">Đã xuất viện</option>
                        <option value="transferred">Chuyển viện</option>
                        <option value="deceased">Đã mất</option>
                        <option value="other">Lý do khác</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Ghi chú</label>
                    <textarea id="deactivation-notes" rows="3"
                        class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all font-medium resize-none"
                        placeholder="Thông tin bổ sung (không bắt buộc)"></textarea>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeDeactivateModal()"
                        class="flex-1 px-6 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-sm hover:bg-slate-200 transition-all">
                        Hủy
                    </button>
                    <button type="submit"
                        class="flex-1 px-6 py-4 bg-red-600 text-white rounded-2xl font-black text-sm hover:bg-red-700 shadow-xl shadow-red-500/20 transition-all">
                        Vô hiệu hóa
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="common.js"></script>
    <script src="module1.js"></script>
    <script src="module2.js"></script>
    <script src="module3.js"></script>
    <script src="module4.js"></script>
    <script src="module6.js"></script>

    <script>
        // --- State ---
        let currentModuleId = 1;
        let radarChartInstance = null;
        let trendChartInstance = null;
        let timelineChartInstance = null;

        const modules = [
            { id: 1, title: 'Face Sheet (Cơ bản)', icon: 'user' },
            { id: 2, title: 'Họp Phụ Trách', icon: 'message-square' },
            { id: 3, title: 'Đánh giá ADL/IADL', icon: 'clipboard-list' },
            { id: 4, title: 'Sở thích & Quan tâm', icon: 'heart' },
            { id: 5, title: 'Phân tích Tư thế', icon: 'activity' },
            { id: 6, title: 'Thành phần Cơ (SMI)', icon: 'bar-chart-3' },
            { id: 7, title: 'Thể lực & Vận động', icon: 'zap' },
            { id: 8, title: 'Bảo mật & Đồng ý', icon: 'shield-check' },
            { id: 9, title: 'Khảo sát Nhà ở', icon: 'home' }
        ];

        // --- Patient Management Functions ---

        function updateActivePatientDisplay() {
            const patientId = getCurrentPatientId();
            const patient = getPatientById(patientId);

            if (patient) {
                document.getElementById('active-patient-name').textContent = patient.fullName;
                document.getElementById('active-patient-id').textContent = patient.id;
                document.getElementById('patient-initial').textContent = patient.fullName.charAt(0).toUpperCase();
            } else {
                document.getElementById('active-patient-name').textContent = 'Chưa chọn';
                document.getElementById('active-patient-id').textContent = '---';
                document.getElementById('patient-initial').textContent = '?';
            }

            // Also update patient detail profile
            updatePatientDetailProfile();
        }

        function updatePatientDetailProfile() {
            const patientId = getCurrentPatientId();
            const patient = getPatientById(patientId);

            if (patient) {
                // Update avatar
                document.getElementById('patient-avatar').textContent = patient.fullName.charAt(0).toUpperCase();

                // Update name
                document.getElementById('patient-detail-name').textContent = patient.fullName;

                // Update care level
                document.getElementById('patient-detail-care-level').textContent = patient.careLevel || '---';

                // Update ID
                document.getElementById('patient-detail-id').textContent = 'ID: ' + patient.id;

                // Calculate age and format gender
                let ageGenderText = '--- • ---';
                if (patient.dateOfBirth) {
                    const birthDate = new Date(patient.dateOfBirth);
                    const age = new Date().getFullYear() - birthDate.getFullYear();
                    const genderText = patient.gender === 'male' ? 'Nam' : (patient.gender === 'female' ? 'Nữ' : '---');
                    ageGenderText = `${age} tuổi • ${genderText}`;
                }
                document.getElementById('patient-detail-age-gender').textContent = ageGenderText;
            } else {
                document.getElementById('patient-avatar').textContent = '?';
                document.getElementById('patient-detail-name').textContent = 'Chưa chọn bệnh nhân';
                document.getElementById('patient-detail-care-level').textContent = '---';
                document.getElementById('patient-detail-id').textContent = 'ID: ---';
                document.getElementById('patient-detail-age-gender').textContent = '--- • ---';
            }
        }

        function loadPatientList() {
            const patients = getAllPatients();
            const activePatientId = getCurrentPatientId();
            const listContainer = document.getElementById('patient-list');

            if (patients.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-slate-400 text-sm py-4">Chưa có bệnh nhân nào</p>';
                return;
            }

            listContainer.innerHTML = patients.map(patient => {
                const isActive = patient.id === activePatientId;
                return `
                    <button onclick="switchToPatient('${patient.id}')" 
                        class="w-full p-3 rounded-xl hover:bg-slate-50 transition-all text-left ${isActive ? 'bg-blue-50 border-2 border-blue-200' : 'border-2 border-transparent'}">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center text-blue-600 font-black">
                                ${patient.fullName.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-slate-800">${patient.fullName}</p>
                                <p class="text-xs text-slate-400">${patient.id}</p>
                            </div>
                            ${isActive ? '<i data-lucide="check" class="w-4 h-4 text-blue-600"></i>' : ''}
                        </div>
                    </button>
                `;
            }).join('');

            lucide.createIcons();
        }

        function togglePatientSwitcher() {
            const dropdown = document.getElementById('patient-switcher-dropdown');
            dropdown.classList.toggle('hidden');
            if (!dropdown.classList.contains('hidden')) {
                loadPatientList();
            }
        }

        function switchToPatient(patientId) {
            setCurrentPatientId(patientId);
            updateActivePatientDisplay();
            togglePatientSwitcher();

            // Reload current module to show data for new patient
            if (currentModuleId) {
                renderModuleView(currentModuleId);
            }

            showToast('Đã chuyển sang bệnh nhân: ' + getPatientById(patientId).fullName, 'success');
        }

        function openCreatePatientModal() {
            document.getElementById('create-patient-modal').classList.remove('hidden');
            togglePatientSwitcher(); // Close dropdown
        }

        function closeCreatePatientModal() {
            document.getElementById('create-patient-modal').classList.add('hidden');
            document.getElementById('create-patient-form').reset();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            const switcher = document.getElementById('patient-switcher-btn');
            const dropdown = document.getElementById('patient-switcher-dropdown');

            if (switcher && dropdown && !switcher.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Handle patient creation form
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('create-patient-form').addEventListener('submit', function (e) {
                e.preventDefault();

                const patientData = {
                    fullName: document.getElementById('new-patient-name').value,
                    dateOfBirth: document.getElementById('new-patient-dob').value,
                    gender: document.getElementById('new-patient-gender').value,
                    careLevel: document.getElementById('new-patient-care-level').value
                };

                const newPatient = createPatient(patientData);

                closeCreatePatientModal();
                updateActivePatientDisplay();
                renderDashboard(); // Refresh dashboard table
                showToast('Đã tạo bệnh nhân: ' + newPatient.fullName, 'success');

                // Switch to patient detail view
                switchTab('patients');
                setActiveModule(1);
            });
        });

        // Jump to Top/Bottom Helper
        function initScrollButtons() {
            // Create Container
            const container = document.createElement('div');
            container.id = 'scroll-buttons-container';
            container.className = 'fixed bottom-8 right-8 flex flex-col gap-2 z-50 hidden transition-opacity duration-300';
            container.innerHTML = `
                <button onclick="scrollToModule('top')" class="p-3 bg-white/80 backdrop-blur text-slate-600 rounded-full shadow-lg hover:bg-white hover:text-blue-600 hover:scale-110 active:scale-90 transition-all border border-slate-100 ring-1 ring-slate-900/5 group" title="Lên đầu trang">
                    <i data-lucide="arrow-up" class="w-5 h-5"></i>
                </button>
                <button onclick="scrollToModule('bottom')" class="p-3 bg-white/80 backdrop-blur text-slate-600 rounded-full shadow-lg hover:bg-white hover:text-blue-600 hover:scale-110 active:scale-90 transition-all border border-slate-100 ring-1 ring-slate-900/5 group" title="Xuống cuối trang">
                    <i data-lucide="arrow-down" class="w-5 h-5"></i>
                </button>
            `;
            document.body.appendChild(container);

            // Re-init icons for new buttons
            lucide.createIcons();

            // Scroll Logic
            window.scrollToModule = (direction) => {
                const container = document.getElementById('module-content');
                if (!container) return;

                if (direction === 'top') {
                    container.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                }
            };

            // Visibility Logic: Show only when business section is active
            const observer = new MutationObserver(() => {
                const businessSection = document.getElementById('section-business');
                const scrollBtns = document.getElementById('scroll-buttons-container');

                if (businessSection && !businessSection.classList.contains('hidden-section')) {
                    scrollBtns.classList.remove('hidden');
                } else {
                    scrollBtns.classList.add('hidden');
                }
            });

            const businessSection = document.getElementById('section-business');
            if (businessSection) {
                observer.observe(businessSection, { attributes: true, attributeFilter: ['class'] });
            }
        }

        // --- Core ---
        window.onload = () => {
            lucide.createIcons();
            renderModuleTabs();
            renderPatientList();
            updateActivePatientDisplay();
            initScrollButtons(); // Initialize helper
        };

        // --- Mockup Helper: Clear All Data ---
        document.addEventListener('keydown', function (e) {
            // Ctrl+Shift+Delete (or Cmd+Shift+Delete on Mac)
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Delete') {
                e.preventDefault();

                if (confirm('⚠️ MOCKUP MODE: Xóa tất cả dữ liệu?\n\nĐiều này sẽ xóa:\n- Tất cả bệnh nhân\n- Tất cả dữ liệu module\n- Reset về trạng thái ban đầu\n\nBạn có chắc chắn?')) {
                    // Clear all localStorage data
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('mirabocaresync_')) {
                            keysToRemove.push(key);
                        }
                    }

                    keysToRemove.forEach(key => localStorage.removeItem(key));

                    showToast('✅ Đã xóa tất cả dữ liệu mockup!', 'success');

                    // Reload page to reset UI
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            }
        });

        function switchTab(tab) {
            document.getElementById('section-patients').classList.toggle('hidden-section', tab !== 'patients');
            document.getElementById('section-business').classList.toggle('hidden-section', tab !== 'business');
            document.getElementById('btn-patients').classList.toggle('sidebar-item-active', tab === 'patients');
            document.getElementById('btn-business').classList.toggle('sidebar-item-active', tab === 'business');

            if (tab === 'patients') {
                document.getElementById('header-title').innerText = 'Danh sách bệnh nhân';
                renderPatientList(); // Refresh patient list
            } else if (tab === 'business') {
                document.getElementById('header-title').innerText = 'Nghiệp vụ - ' + (getPatientById(getCurrentPatientId())?.fullName || 'Chưa chọn');
            }
        }

        function openPatient(id) {
            // Set the patient as active
            setCurrentPatientId(id);
            updateActivePatientDisplay();

            switchTab('business');
            setActiveModule(1);
        }

        let currentFilter = 'all'; // Track current filter

        function renderPatientList(filter = currentFilter) {
            currentFilter = filter;

            // Update filter button styles
            document.getElementById('filter-all').className = filter === 'all'
                ? 'px-4 py-2 rounded-xl text-xs font-bold bg-blue-600 text-white'
                : 'px-4 py-2 rounded-xl text-xs font-bold bg-slate-100 text-slate-600 hover:bg-slate-200';
            document.getElementById('filter-active').className = filter === 'active'
                ? 'px-4 py-2 rounded-xl text-xs font-bold bg-blue-600 text-white'
                : 'px-4 py-2 rounded-xl text-xs font-bold bg-slate-100 text-slate-600 hover:bg-slate-200';
            document.getElementById('filter-inactive').className = filter === 'inactive'
                ? 'px-4 py-2 rounded-xl text-xs font-bold bg-blue-600 text-white'
                : 'px-4 py-2 rounded-xl text-xs font-bold bg-slate-100 text-slate-600 hover:bg-slate-200';

            // Populate patient table
            let patients = getAllPatients();

            // Apply filter
            if (filter === 'active') {
                patients = patients.filter(p => p.active !== false);
            } else if (filter === 'inactive') {
                patients = patients.filter(p => p.active === false);
            }

            const tbody = document.querySelector('#section-patients tbody');

            if (!tbody) return;

            if (patients.length === 0) {
                const message = filter === 'all'
                    ? 'Chưa có bệnh nhân nào. Click "Tạo bệnh nhân mới" để bắt đầu.'
                    : filter === 'active'
                        ? 'Không có bệnh nhân đang hoạt động.'
                        : 'Không có bệnh nhân đã vô hiệu.';

                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-10 py-8 text-center text-slate-400">
                            <p class="text-sm font-semibold">${message}</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = patients.map(patient => {
                const initial = patient.fullName.charAt(0).toUpperCase();
                const isActive = patient.active !== false;

                // Status badge
                let statusBadge = '';
                if (isActive) {
                    statusBadge = '<span class="px-4 py-1.5 bg-emerald-100 text-emerald-700 rounded-full text-[10px] font-black uppercase tracking-wider">Đang hoạt động</span>';
                } else if (patient.status === 'deceased') {
                    statusBadge = '<span class="px-4 py-1.5 bg-red-100 text-red-700 rounded-full text-[10px] font-black uppercase tracking-wider">Đã mất</span>';
                } else {
                    statusBadge = '<span class="px-4 py-1.5 bg-slate-100 text-slate-500 rounded-full text-[10px] font-black uppercase tracking-wider">Đã vô hiệu</span>';
                }

                // Action button
                let actionButton = '';
                if (isActive) {
                    actionButton = `
                        <button onclick="openDeactivateModal('${patient.id}')"
                            class="bg-slate-100 text-slate-600 px-4 py-2 rounded-xl text-xs font-black hover:bg-red-100 hover:text-red-600 transition-all mr-2">
                            <i data-lucide="archive" class="w-3 h-3 inline"></i> Vô hiệu hóa
                        </button>
                        <button onclick="openPatient('${patient.id}')"
                            class="bg-slate-900 text-white px-6 py-2 rounded-2xl text-xs font-black hover:bg-blue-600 transition-all shadow-lg shadow-slate-200">
                            Chi tiết hồ sơ
                        </button>
                    `;
                } else {
                    actionButton = `
                        <button onclick="confirmReactivate('${patient.id}')"
                            class="bg-emerald-100 text-emerald-700 px-4 py-2 rounded-xl text-xs font-black hover:bg-emerald-200 transition-all mr-2">
                            <i data-lucide="rotate-ccw" class="w-3 h-3 inline"></i> Kích hoạt lại
                        </button>
                        <button onclick="openPatient('${patient.id}')"
                            class="bg-slate-900 text-white px-6 py-2 rounded-2xl text-xs font-black hover:bg-blue-600 transition-all shadow-lg shadow-slate-200">
                            Chi tiết hồ sơ
                        </button>
                    `;
                }

                return `
                    <tr class="hover:bg-slate-50/50 transition-all">
                        <td class="px-10 py-6 text-slate-800 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-2xl bg-blue-100 flex items-center justify-center text-blue-600 font-black">
                                ${initial}
                            </div>
                            ${patient.fullName}
                        </td>
                        <td class="px-10 py-6 text-slate-600">${patient.careLevel || 'Chăm sóc 1'}</td>
                        <td class="px-10 py-6">
                            ${statusBadge}
                        </td>
                        <td class="px-10 py-6 text-right">
                            ${actionButton}
                        </td>
                    </tr>
                `;
            }).join('');

            lucide.createIcons();
        }

        function filterPatients(status) {
            renderPatientList(status);
        }

        function openDeactivateModal(patientId) {
            document.getElementById('deactivate-patient-id').value = patientId;
            document.getElementById('deactivate-patient-modal').classList.remove('hidden');
        }

        function closeDeactivateModal() {
            document.getElementById('deactivate-patient-modal').classList.add('hidden');
            document.getElementById('deactivate-patient-form').reset();
        }

        function confirmReactivate(patientId) {
            const patient = getPatientById(patientId);
            if (!patient) return;

            if (confirm(`Kích hoạt lại bệnh nhân "${patient.fullName}"?\n\nBệnh nhân sẽ được đánh dấu là đang hoạt động.`)) {
                if (reactivatePatient(patientId)) {
                    showToast(`Đã kích hoạt lại bệnh nhân: ${patient.fullName}`, 'success');
                    renderPatientList();
                }
            }
        }

        // Handle deactivation form submission
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('deactivate-patient-form')?.addEventListener('submit', function (e) {
                e.preventDefault();

                const patientId = document.getElementById('deactivate-patient-id').value;
                const reason = document.getElementById('deactivation-reason').value;
                const notes = document.getElementById('deactivation-notes').value;

                const patient = getPatientById(patientId);
                if (!patient) return;

                if (deactivatePatient(patientId, reason, notes)) {
                    showToast(`Đã vô hiệu hóa bệnh nhân: ${patient.fullName}`, 'success');
                    closeDeactivateModal();
                    renderPatientList();
                }
            });
        });

        function renderModuleTabs() {
            const container = document.getElementById('module-tabs');
            container.innerHTML = modules.map(m => `
                <button onclick="setActiveModule(${m.id})" id="module-btn-${m.id}" 
                    class="w-full flex items-center justify-between p-5 rounded-3xl border transition-all text-left bg-white border-slate-100 hover:border-blue-300 group shadow-sm">
                    <div class="flex items-center gap-5">
                        <div class="module-icon-box p-3 rounded-2xl bg-slate-100 text-slate-500 transition-all">
                            <i data-lucide="${m.icon}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="text-[9px] font-black uppercase text-slate-400 tracking-widest mb-0.5">Nghiệp vụ 0${m.id}</p>
                            <p class="text-sm font-bold text-slate-700">${m.title.split(' (')[0]}</p>
                        </div>
                    </div>
                </button>
            `).join('');
            lucide.createIcons();
        }

        function setActiveModule(id) {
            currentModuleId = id;
            document.getElementById('module-title').innerText = modules.find(m => m.id === id).title;

            modules.forEach(m => {
                const btn = document.getElementById(`module-btn-${m.id}`);
                const iconBox = btn.querySelector('.module-icon-box');
                if (m.id === id) {
                    btn.classList.add('active-module', 'border-blue-400', 'ring-[6px]', 'ring-blue-50');
                    iconBox.classList.add('bg-blue-600', 'text-white');
                    iconBox.classList.remove('bg-slate-100', 'text-slate-500');
                } else {
                    btn.classList.remove('active-module', 'border-blue-400', 'ring-[6px]', 'ring-blue-50');
                    iconBox.classList.remove('bg-blue-600', 'text-white');
                    iconBox.classList.add('bg-slate-100', 'text-slate-500');
                }
            });

            renderModuleView(id);
        }

        function renderModuleView(id) {
            const content = document.getElementById('module-content');

            // Check if module content variable exists (e.g., module1Content)
            const contentVarName = 'module' + id + 'Content';

            if (window[contentVarName]) {
                content.innerHTML = window[contentVarName];

                // Initialize module logic if init function exists
                const initFuncName = 'initModule' + id;
                if (typeof window[initFuncName] === 'function') {
                    // Slight delay to ensure DOM is ready
                    setTimeout(() => window[initFuncName](), 0);
                }
            } else {
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-[400px] bg-slate-50 rounded-[48px] border-4 border-dashed border-slate-100">
                        <i data-lucide="package" class="w-16 h-16 text-slate-200 mb-6"></i>
                        <p class="font-black text-slate-400 uppercase tracking-[4px] text-xs">Module đang cập nhật dữ liệu</p>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function renderDashboard() {
            // Placeholder for dashboard logic if needed
        }
    </script>
</body>

</html>